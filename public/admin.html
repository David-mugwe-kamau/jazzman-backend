<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' https://cdn.jsdelivr.net; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline'; img-src 'self' data: blob:; connect-src 'self';">
    <title>JazzMan Housecalls - Admin Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        .badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .badge-info {
            background-color: #17a2b8;
            color: white;
        }
        
        .badge-warning {
            background-color: #ffc107;
            color: #212529;
        }
        
        .badge-danger {
            background-color: #dc3545;
            color: white;
        }
        
        .badge-dark {
            background-color: #343a40;
            color: white;
        }
        
        .badge-secondary {
            background-color: #6c757d;
            color: white;
        }
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            border-radius: 8px;
            padding: 20px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .modal-body {
            margin-bottom: 20px;
        }
        
        .modal-footer {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.3s;
        }
        
        .close-btn:hover {
            background: #f0f0f0;
        }
        
        .modal-content form {
            padding-bottom: 20px;
        }
        
        /* Notification System */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            z-index: 10001;
            min-width: 300px;
            max-width: 400px;
            border-left: 4px solid #1976d2;
        }
        
        .notification-success {
            border-left-color: #28a745;
        }
        
        .notification-error {
            border-left-color: #dc3545;
        }
        
        .notification-warning {
            border-left-color: #ffc107;
        }
        
        .notification-content {
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .notification-message {
            flex: 1;
            margin-right: 15px;
        }
        
        .notification-close {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            color: #666;
            padding: 0;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.3s;
        }
        
        .notification-close:hover {
            background: #f0f0f0;
        }
        
        /* Booking Details and Forms */
        .booking-details .detail-row {
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        
        .booking-details .detail-row:last-child {
            border-bottom: none;
        }
        
        .reschedule-form .form-group {
            margin-bottom: 20px;
        }
        
        .reschedule-form .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }
        
        .reschedule-form .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: #f8f9fa; 
            color: #333;
        }
        
        /* Header Styles */
        .header {
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 30px;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 24px;
            font-weight: bold;
            color: #1976d2;
        }
        
        .logo-icon {
            width: 40px;
            height: 40px;
            background: #1976d2;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        
        .menu-toggle {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #666;
            padding: 10px;
            border-radius: 5px;
            transition: background-color 0.3s;
        }
        
        .menu-toggle:hover {
            background: #f0f0f0;
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .header-icon {
            position: relative;
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            color: #666;
            padding: 10px;
            border-radius: 5px;
            transition: background-color 0.3s;
        }
        
        .header-icon:hover {
            background: #f0f0f0;
        }
        
        .notification-badge {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #e74c3c;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .user-profile {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            padding: 10px;
            border-radius: 5px;
            transition: background-color 0.3s;
        }
        
        .user-profile:hover {
            background: #f0f0f0;
        }
        
        .user-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: #1976d2;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        
        /* Sidebar Styles */
        .sidebar {
            position: fixed;
            left: 0;
            top: 70px;
            width: 250px;
            height: calc(100vh - 70px);
            background: white;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            overflow-y: auto;
            transition: transform 0.3s;
            z-index: 999;
        }
        
        .sidebar.collapsed {
            transform: translateX(-250px);
        }
        
        .nav-menu {
            list-style: none;
            padding: 20px 0;
        }
        
        .nav-item {
            margin: 5px 0;
        }
        
        .nav-link {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px 25px;
            color: #666;
            text-decoration: none;
            transition: all 0.3s;
            border-left: 3px solid transparent;
        }
        
        .nav-link:hover, .nav-link.active {
            background: #f8f9fa;
            color: #1976d2;
            border-left-color: #1976d2;
        }
        
        .nav-link i {
            font-size: 18px;
            width: 20px;
            text-align: center;
        }
        
        /* Main Content */
        .main-content {
            margin-left: 250px;
            margin-top: 70px;
            padding: 30px;
            min-height: calc(100vh - 70px);
            transition: margin-left 0.3s;
        }
        
        .main-content.expanded {
            margin-left: 0;
        }
        
        .page-header {
            margin-bottom: 30px;
        }
        
        .page-title {
            font-size: 28px;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
        }
        
        .page-subtitle {
            color: #666;
            font-size: 16px;
        }
        
        /* Dashboard Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-left: 4px solid #1976d2;
        }
        
        .stat-card.success { border-left-color: #27ae60; }
        .stat-card.warning { border-left-color: #f39c12; }
        .stat-card.danger { border-left-color: #e74c3c; }
        .stat-card.info { border-left-color: #3498db; }
        
        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .stat-title {
            font-size: 14px;
            color: #666;
            font-weight: 500;
        }
        
        .stat-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: white;
        }
        
        .stat-icon.success { background: #27ae60; }
        .stat-icon.warning { background: #f39c12; }
        .stat-icon.danger { background: #e74c3c; }
        .stat-icon.info { background: #3498db; }
        
        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }
        
        .stat-change {
            font-size: 14px;
            font-weight: 500;
        }
        
        .stat-change.positive { color: #27ae60; }
        .stat-change.negative { color: #e74c3c; }
        
        /* Charts Section */
        .charts-section {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 25px;
            margin-bottom: 30px;
        }
        
        .chart-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .chart-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 20px;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
        }
        
        /* Tables */
        .table-section {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 25px;
        }
        
        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .table-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }
        
        .table-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: #1976d2;
            color: white;
        }
        
        .btn-primary:hover {
            background: #1565c0;
        }
        
        .btn-success {
            background: #27ae60;
            color: white;
        }
        
        .btn-success:hover {
            background: #229954;
        }
        
        .btn-warning {
            background: #f39c12;
            color: white;
        }
        
        .btn-warning:hover {
            background: #e67e22;
        }
        
        .btn-info {
            background: #3498db;
            color: white;
        }
        
        .btn-info:hover {
            background: #2980b9;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }
        
        .search-box {
            position: relative;
        }
        
        .search-box input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            width: 250px;
        }
        
        .form-control {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #1976d2;
            box-shadow: 0 0 0 2px rgba(25, 118, 210, 0.2);
        }
        
        .detail-row {
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        
        .detail-row:last-child {
            border-bottom: none;
        }
        
        .detail-row strong {
            display: inline-block;
            width: 120px;
            color: #666;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #333;
        }
        
        .modal-footer {
            padding: 20px;
            border-top: 1px solid #eee;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        .btn-success {
            background: #27ae60;
            color: white;
        }
        
        .btn-success:hover {
            background: #229954;
        }
        
        .btn-danger {
            background: #e74c3c;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c0392b;
        }
        
        .btn-warning {
            background: #f39c12;
            color: white;
        }
        
        .btn-warning:hover {
            background: #e67e22;
        }
        
        .table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .table th, .table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        .table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }
        
        .table tr:hover {
            background: #f8f9fa;
        }
        
        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status-completed { background: #d4edda; color: #155724; }
        .status-pending { background: #fff3cd; color: #856404; }
        .status-cancelled { background: #f8d7da; color: #721c24; }
        
        .badge-success {
            background-color: #d4edda;
            color: #155724;
        }
        
        .badge-warning {
            background-color: #fff3cd;
            color: #856404;
        }
        
        /* Action buttons */
        .action-buttons {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }
        
        .action-buttons .btn {
            padding: 4px 8px;
            font-size: 12px;
            min-width: 32px;
        }
        
        /* Modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            border-radius: 8px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }
        
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h3 {
            margin: 0;
            color: #333;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .close-btn:hover {
            color: #333;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .booking-details .detail-row {
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
        }
        
        .booking-details .detail-row:last-child {
            border-bottom: none;
        }
        
        .booking-details .detail-row strong {
            color: #333;
            min-width: 120px;
        }
        
        /* Payment form styles */
        .payment-form .form-group {
            margin-bottom: 20px;
        }
        
        .payment-form label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        
        .payment-form .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .payment-form .form-control:focus {
            outline: none;
            border-color: #1976d2;
            box-shadow: 0 0 0 2px rgba(25, 118, 210, 0.2);
        }
        
        .payment-form .amount {
            font-size: 18px;
            font-weight: 700;
            color: #27ae60;
        }
        
        .payment-form .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }
        
        .payment-form .btn {
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 600;
        }
        
        /* Tabs */
        .tabs {
            display: flex;
            border-bottom: 1px solid #eee;
            margin-bottom: 20px;
        }
        
        .tab {
            padding: 15px 25px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            font-weight: 500;
        }
        
        .tab.active {
            border-bottom-color: #1976d2;
            color: #1976d2;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-250px);
            }
            
            .sidebar.open {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .charts-section {
                grid-template-columns: 1fr;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* Barber Photo Styles */
        .barber-photo {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            margin: 0 auto;
            border: 2px solid #27ae60;
        }
        
        .barber-photo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }
        
        .photo-upload-btn {
            padding: 3px 8px;
            margin-top: 5px;
            background: #17a2b8;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.7rem;
            transition: background-color 0.3s;
        }
        
        .photo-upload-btn:hover {
            background: #138496;
        }

        /* ===== WORKING HOURS STYLES ===== */
        
        /* Switch toggle for open/closed */
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
            margin-right: 10px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #28a745;
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .status-text {
            font-size: 0.9rem;
            font-weight: 500;
            margin-left: 5px;
        }

        /* Time input styling */
        .time-input {
            padding: 6px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
            width: 80px;
            margin: 2px 0;
        }

        .time-input:disabled {
            background-color: #f5f5f5;
            color: #999;
            cursor: not-allowed;
        }

        .time-input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
        }

        /* Notes input styling */
        .notes-input {
            padding: 6px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
            width: 120px;
        }

        .notes-input:disabled {
            background-color: #f5f5f5;
            color: #999;
            cursor: not-allowed;
        }

        .notes-input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
        }

        /* Button group styling */
        .button-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .button-group .btn {
            margin: 0;
        }

        /* Working hours table specific styling */
        .working-hours-container {
            overflow-x: auto;
        }

        #workingHoursTable th {
            background-color: #f8f9fa;
            font-weight: 600;
            text-align: center;
            padding: 12px 8px;
        }

        #workingHoursTable td {
            text-align: center;
            padding: 12px 8px;
            vertical-align: middle;
        }

        #workingHoursTable td:first-child {
            text-align: left;
            font-weight: 600;
        }

        /* Status indicators */
        .stat-value.success {
            color: #28a745;
        }

        .stat-value.danger {
            color: #dc3545;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .time-input, .notes-input {
                width: 100%;
                margin: 2px 0;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            .button-group .btn {
                width: 100%;
            }
        }

        /* Professional Dashboard Styling */
        .customer-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .customer-info strong {
            font-size: 14px;
            color: #2c3e50;
        }

        .customer-info small {
            font-size: 12px;
            color: #7f8c8d;
        }

        .btn-group {
            display: flex;
            gap: 2px;
        }

        .btn-group .btn {
            padding: 4px 8px;
            font-size: 12px;
            border-radius: 4px;
        }

        .badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            text-transform: uppercase;
        }

        .badge-warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .badge-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .badge-danger {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .badge-secondary {
            background-color: #e2e3e5;
            color: #383d41;
            border: 1px solid #d6d8db;
        }

        /* Clean table styling */
        .table {
            border-collapse: collapse;
            width: 100%;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .table th {
            background: #f8f9fa;
            padding: 12px 8px;
            font-weight: 600;
            color: #495057;
            border-bottom: 2px solid #dee2e6;
            font-size: 13px;
        }

        .table td {
            padding: 12px 8px;
            border-bottom: 1px solid #f1f3f4;
            font-size: 13px;
            vertical-align: middle;
        }

        .table tbody tr:hover {
            background-color: #f8f9fa;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-left">
            <button class="menu-toggle" id="menuToggle">☰</button>
            <div class="logo">
                <div class="logo-icon">J</div>
                JazzMan
            </div>
        </div>
        <div class="header-right">
            <button class="header-icon">
                🔍
            </button>
            <button class="header-icon">
                🔔
                <span class="notification-badge">3</span>
            </button>
            <button class="header-icon">
                ✉️
                <span class="notification-badge">1</span>
            </button>
            <div class="user-profile">
                <div class="user-avatar">A</div>
                <span>Admin</span>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <ul class="nav-menu">
            <li class="nav-item">
                <a href="#overview" class="nav-link active" data-tab="overview">
                    <i>📊</i> Dashboard
                </a>
            </li>
            <li class="nav-item">
                <a href="#analytics" class="nav-link" data-tab="analytics">
                    <i>📈</i> Analytics
                </a>
            </li>
            <li class="nav-item">
                <a href="#barbers" class="nav-link" data-tab="barbers">
                    <i>✂️</i> Barbers
                </a>
            </li>
            <li class="nav-item">
                <a href="#bookings" class="nav-link" data-tab="bookings">
                    <i>📅</i> Bookings
                </a>
            </li>
            <li class="nav-item">
                <a href="#payments" class="nav-link" data-tab="payments">
                    <i>💳</i> Payment Management
                </a>
            </li>
            <li class="nav-item">
                <a href="#clients" class="nav-link" data-tab="clients">
                    <i>👥</i> Client Management
                </a>
            </li>
            <li class="nav-item">
                <a href="#reports" class="nav-link" data-tab="reports">
                    <i>📋</i> Reports
                </a>
            </li>
            <li class="nav-item">
                <a href="#working-hours" class="nav-link" data-tab="working-hours">
                    <i>🕐</i> Working Hours
                </a>
            </li>
                            <li class="nav-item">
                    <a href="#settings" class="nav-link" data-tab="settings">
                        <i>⚙️</i> Settings
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" id="logoutBtn">
                        <i>🚪</i> Logout
                    </a>
                </li>
            </ul>
        </div>

    <!-- Main Content -->
    <div class="main-content" id="mainContent">
        <div id="overview" class="tab-content active">
            <div class="page-header">
                <h1 class="page-title">Dashboard Overview</h1>
                <p class="page-subtitle">Welcome back! Here's what's happening with JazzMan Housecalls today.</p>
            </div>

            <!-- Stats Cards -->
            <div class="dashboard-grid">
                <div class="stat-card success">
                    <div class="stat-header">
                        <div class="stat-title">Total Bookings</div>
                        <div class="stat-icon success">📅</div>
                    </div>
                    <div class="stat-value" id="totalBookings">-</div>
                    <div class="stat-change positive">+12% from last week</div>
                </div>
                
                <div class="stat-card info">
                    <div class="stat-header">
                        <div class="stat-title">Revenue</div>
                        <div class="stat-icon info">💰</div>
                    </div>
                    <div class="stat-value" id="totalRevenue">-</div>
                    <div class="stat-change positive">+8% from last week</div>
                </div>
                
                <div class="stat-card warning">
                    <div class="stat-header">
                        <div class="stat-title">Active Barbers</div>
                        <div class="stat-icon warning">✂️</div>
                    </div>
                    <div class="stat-value" id="activeBarbers">-</div>
                    <div class="stat-change positive">+2 this month</div>
                </div>
                
                <div class="stat-card danger">
                    <div class="stat-header">
                        <div class="stat-title">Customers</div>
                        <div class="stat-icon danger">👥</div>
                    </div>
                    <div class="stat-value" id="totalCustomers">-</div>
                    <div class="stat-change positive">+15% from last week</div>
                </div>
            </div>

            <!-- Charts Section -->
            <div class="charts-section">
                <div class="chart-card">
                    <div class="chart-title">Revenue & Bookings Trend</div>
                    <div class="chart-container">
                        <canvas id="trendChart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <div class="chart-title">Service Breakdown</div>
                    <div class="chart-container">
                        <canvas id="serviceChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Top Performing Barbers -->
            <div class="table-section">
                <div class="table-header">
                    <div class="table-title">Top Performing Barbers</div>
                </div>
                <table class="table" id="topBarbersTable">
                    <thead>
                        <tr>
                            <th>Barber</th>
                            <th>Badge ID</th>
                            <th>Bookings</th>
                            <th>Revenue</th>
                            <th>Avg. Service Price</th>
                        </tr>
                    </thead>
                    <tbody id="topBarbersBody">
                        <tr><td colspan="5">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div id="analytics" class="tab-content">
            <div class="page-header">
                <h1 class="page-title">Analytics</h1>
                <p class="page-subtitle">Detailed insights and performance metrics</p>
            </div>
            
            <div class="tabs">
                <div class="tab active" data-analytics-tab="daily">Daily Analysis</div>
                <div class="tab" data-analytics-tab="weekly">Weekly Analysis</div>
                <div class="tab" data-analytics-tab="revenue">Revenue Analytics</div>
            </div>

            <div id="daily" class="tab-content active">
                <div class="chart-card">
                    <div class="chart-title">Daily Bookings & Revenue</div>
                    <div class="chart-container">
                        <canvas id="dailyChart"></canvas>
                    </div>
                </div>
            </div>

            <div id="weekly" class="tab-content">
                <div class="chart-card">
                    <div class="chart-title">Weekly Trends</div>
                    <div class="chart-container">
                        <canvas id="weeklyChart"></canvas>
                    </div>
                </div>
            </div>

            <div id="revenue" class="tab-content">
                <div class="chart-card">
                    <div class="chart-title">Payment Method Breakdown</div>
                    <div class="chart-container">
                        <canvas id="paymentChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div id="barbers" class="tab-content">
            <div class="page-header">
                <h1 class="page-title">Barber Management</h1>
                <p class="page-subtitle">Manage your barber team and their performance</p>
            </div>
            
            <div class="table-section">
                <div class="table-header">
                    <div class="table-title">Active Barbers</div>
                    <div class="table-actions">
                        <button class="btn btn-success" id="refreshBarbersBtn">
                            🔄 Refresh
                        </button>
                        <button class="btn btn-primary" id="addBarberBtn">
                            ➕ Add New Barber
                        </button>
                        <button class="btn btn-danger" id="resetDbBtn">
                            🗑️ Reset Database
                        </button>
                    </div>
                </div>
                <table class="table" id="barbersTable">
                    <thead>
                        <tr>
                            <th>Photo</th>
                            <th>Name</th>
                            <th>Badge ID</th>
                            <th>Phone</th>
                            <th>Total Services</th>
                            <th>Total Earnings</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="barbersBody">
                        <tr><td colspan="8">Loading...</td></tr>
                    </tbody>
                </table>
            </div>

            <div class="table-section">
                <div class="table-header">
                    <div class="table-title">Blocked Barbers</div>
                    <span style="color: #666; font-size: 0.9rem;">Barbers who are currently blocked from receiving bookings</span>
                </div>
                <table class="table" id="blockedBarbersTable">
                    <thead>
                                                    <tr>
                                <th>Photo</th>
                                <th>Name</th>
                                <th>Badge ID</th>
                                <th>Phone</th>
                                <th>Block Reason</th>
                                <th>Blocked At</th>
                                <th>Category</th>
                                <th>Severity</th>
                                <th>Block Type</th>
                                <th>Duration</th>
                                <th>Expires In</th>
                                <th>Actions</th>
                            </tr>
                    </thead>
                    <tbody id="blockedBarbersBody">
                        <tr><td colspan="10">Loading blocked barbers...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div id="bookings" class="tab-content">
            <div class="page-header">
                <h1 class="page-title">Bookings</h1>
                <p class="page-subtitle">Manage customer appointments and scheduling</p>
            </div>
            
            <div class="table-section">
                <div class="table-header">
                    <div class="table-title">Current & Future Bookings</div>
                    <div class="table-actions">
                        <button id="toggleCompletedBtn" class="btn btn-outline-secondary btn-sm">
                            <i>📋</i> View All History
                        </button>
                        <div class="search-box">
                            <input type="text" id="bookingSearch" placeholder="Search bookings..." class="form-control">
                        </div>
                    </div>
                </div>
                <table class="table" id="bookingsTable">
                    <thead>
                        <tr>
                            <th>Customer</th>
                            <th>Service</th>
                            <th>Date & Time</th>
                            <th>Barber</th>
                            <th>Price</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="bookingsBody">
                        <tr><td colspan="7">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div id="payments" class="tab-content">
            <div class="page-header">
                <h1 class="page-title">Payment Management</h1>
                <p class="page-subtitle">Track payments and update status when barbers receive payment from customers</p>
            </div>
            
            <!-- Payment Stats -->
            <div class="dashboard-grid">
                <div class="stat-card success">
                    <div class="stat-header">
                        <div class="stat-title">Total Revenue</div>
                        <div class="stat-icon success">💰</div>
                    </div>
                    <div class="stat-value" id="totalRevenuePayments">-</div>
                    <div class="stat-change">All time earnings</div>
                </div>
                
                <div class="stat-card info">
                    <div class="stat-header">
                        <div class="stat-title">Pending Payments</div>
                        <div class="stat-icon info">⏳</div>
                    </div>
                    <div class="stat-value" id="pendingPayments">-</div>
                    <div class="stat-change">Awaiting collection</div>
                </div>
                
                <div class="stat-card warning">
                    <div class="stat-header">
                        <div class="stat-title">Received Payments</div>
                        <div class="stat-icon warning">✅</div>
                    </div>
                    <div class="stat-value" id="receivedPayments">-</div>
                    <div class="stat-change">Collected by barbers</div>
                </div>
                
                <div class="stat-card danger">
                    <div class="stat-header">
                        <div class="stat-title">Today's Revenue</div>
                        <div class="stat-icon danger">📅</div>
                    </div>
                    <div class="stat-value" id="todayRevenue">-</div>
                    <div class="stat-change">Today's earnings</div>
                </div>
            </div>

            <!-- Payment Controls -->
            <div class="table-section">
                <div class="table-header">
                    <div class="table-title">Payment Management</div>
                    <div class="table-actions">
                        <button id="addPaymentBtn" class="btn btn-success">
                            <i>➕</i> Add Payment
                        </button>
                        <button id="testDailySummaryBtn" class="btn btn-info">
                            <i>📊</i> Test Daily Summary
                        </button>
                        <div class="search-box">
                            <input type="text" id="paymentSearch" placeholder="Search payments..." class="form-control">
                        </div>
                        <select id="paymentStatusFilter" class="form-control">
                            <option value="">All Statuses</option>
                            <option value="pending">Pending</option>
                            <option value="received">Received</option>
                        </select>
                    </div>
                </div>
                
                <table class="table" id="paymentsTable">
                    <thead>
                        <tr>
                            <th>Booking ID</th>
                            <th>Customer</th>
                            <th>Service</th>
                            <th>Amount</th>
                            <th>Method</th>
                            <th>Status</th>
                            <th>Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="paymentsBody">
                        <tr><td colspan="8">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div id="clients" class="tab-content">
            <div class="page-header">
                <h1 class="page-title">Client Management</h1>
                <p class="page-subtitle">Manage returning customers and their preferences</p>
            </div>
            
            <!-- Client Stats -->
            <div class="dashboard-grid">
                <div class="stat-card success">
                    <div class="stat-header">
                        <div class="stat-title">Total Clients</div>
                        <div class="stat-icon success">👥</div>
                    </div>
                    <div class="stat-value" id="totalClients">-</div>
                    <div class="stat-change">All time</div>
                </div>
                
                <div class="stat-card info">
                    <div class="stat-header">
                        <div class="stat-title">Active Clients</div>
                        <div class="stat-icon info">✅</div>
                    </div>
                    <div class="stat-value" id="activeClients">-</div>
                    <div class="stat-change">This month</div>
                </div>
                
                <div class="stat-card warning">
                    <div class="stat-header">
                        <div class="stat-title">Repeat Bookings</div>
                        <div class="stat-icon warning">🔄</div>
                    </div>
                    <div class="stat-value" id="repeatBookings">-</div>
                    <div class="stat-change">Loyal customers</div>
                </div>
            </div>

            <!-- Client Controls -->
            <div class="table-section">
                <div class="table-header">
                    <div class="table-title">Client Database</div>
                    <div class="table-actions">
                        <div class="search-box">
                            <input type="text" id="clientSearch" placeholder="Search clients..." class="form-control">
                        </div>
                        <select id="clientStatusFilter" class="form-control">
                            <option value="">All Clients</option>
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                        </select>
                    </div>
                </div>
                
                <table class="table" id="clientsTable">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Phone</th>
                            <th>Email</th>
                            <th>Total Bookings</th>
                            <th>Total Spent</th>
                            <th>Last Booking</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="clientsBody">
                        <tr><td colspan="7">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div id="reports" class="tab-content">
            <div class="page-header">
                <h1 class="page-title">Reports</h1>
                <p class="page-subtitle">Generate and view business reports</p>
            </div>
            <div class="table-section">
                <div class="table-header">
                    <div class="table-title">Business Reports</div>
                </div>
                <p style="text-align: center; padding: 50px; color: #666;">Reporting features coming soon...</p>
            </div>
        </div>

        <div id="working-hours" class="tab-content">
            <div class="page-header">
                <h1 class="page-title">Working Hours Management</h1>
                <p class="page-subtitle">Configure business operating hours and manage customer booking availability</p>
            </div>
            
            <!-- Current Status Card -->
            <div class="dashboard-grid">
                <div class="stat-card info">
                    <div class="stat-header">
                        <div class="stat-title">Today's Status</div>
                        <div class="stat-icon info">🕐</div>
                    </div>
                    <div class="stat-value" id="todayStatus">Loading...</div>
                    <div class="stat-change" id="todayHours">-</div>
                </div>
                
                <div class="stat-card success">
                    <div class="stat-header">
                        <div class="stat-title">Next Open</div>
                        <div class="stat-icon success">🚪</div>
                    </div>
                    <div class="stat-value" id="nextOpen">-</div>
                    <div class="stat-change" id="nextOpenDetails">-</div>
                </div>
                
                <div class="stat-card warning">
                    <div class="stat-header">
                        <div class="stat-title">Weekly Hours</div>
                        <div class="stat-icon warning">📅</div>
                    </div>
                    <div class="stat-value" id="weeklyHours">-</div>
                    <div class="stat-change">Manage below</div>
                </div>
            </div>

            <!-- Working Hours Table -->
            <div class="table-section">
                <div class="table-header">
                    <div class="table-title">Weekly Schedule</div>
                    <button class="btn btn-primary" id="saveWorkingHoursBtn">
                        <i>💾</i> Save All Changes
                    </button>
                </div>
                
                <div class="working-hours-container">
                    <table class="table" id="workingHoursTable">
                        <thead>
                            <tr>
                                <th>Day</th>
                                <th>Status</th>
                                <th>Open Time</th>
                                <th>Close Time</th>
                                <th>Notes</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="workingHoursBody">
                            <tr><td colspan="6">Loading working hours...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="table-section">
                <div class="table-header">
                    <div class="table-title">Quick Actions</div>
                </div>
                <div class="button-group">
                    <button class="btn btn-secondary" id="resetWorkingHoursBtn">
                        <i>🔄</i> Reset to Defaults
                    </button>
                    <button class="btn btn-info" id="testWorkingHoursBtn">
                        <i>🧪</i> Test Time Validation
                    </button>
                    <button class="btn btn-success" id="exportWorkingHoursBtn">
                        <i>📤</i> Export Schedule
                    </button>
                </div>
            </div>
        </div>

        <div id="settings" class="tab-content">
            <div class="page-header">
                <h1 class="page-title">Settings</h1>
                <p class="page-subtitle">Configure your JazzMan Housecalls system</p>
            </div>
            <div class="table-section">
                <div class="table-header">
                    <div class="table-title">System Settings</div>
                </div>
                <p style="text-align: center; padding: 50px; color: #666;">Settings configuration coming soon...</p>
            </div>
        </div>
    </div>

    <script>
        // Authentication check - must be first
        (function() {
            const token = localStorage.getItem('adminToken');
            if (!token) {
                console.log('No admin token found, redirecting to login');
                window.location.href = '/login';
                return;
            }
            
            // Verify token is valid
            fetch('/api/auth/verify', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    console.log('Invalid token, redirecting to login');
                    localStorage.removeItem('adminToken');
                    localStorage.removeItem('adminUser');
                    window.location.href = '/login';
                    return;
                }
                console.log('Authentication successful, loading dashboard');
            })
            .catch(error => {
                console.error('Token verification failed:', error);
                localStorage.removeItem('adminToken');
                localStorage.removeItem('adminUser');
                window.location.href = '/login';
                return;
            });
        })();

        let currentPeriod = 'week';
        let charts = {};

        let showCompleted = false;

        document.addEventListener('DOMContentLoaded', async function() {
            console.log('Admin dashboard loaded');
            setupEventListeners();
            setupBookingControls();
            
            try {
                // Load data in parallel for better performance
                await Promise.all([
                    loadDashboardData(),
                    loadBarbers(),
                    loadBookings(),
                    loadPayments(),
                    loadWorkingHours()
                ]);
                console.log('All data loaded successfully');
            } catch (error) {
                console.error('Error loading initial data:', error);
            }
        });

        function setupBookingControls() {
            const toggleBtn = document.getElementById('toggleCompletedBtn');
            if (toggleBtn) {
                toggleBtn.addEventListener('click', function() {
                    showCompleted = !showCompleted;
                    toggleBtn.innerHTML = showCompleted ? '<i>👁️</i> Hide History' : '<i>📋</i> View All History';
                    loadBookings();
                });
            }
        }

        function setupEventListeners() {
            // Setup menu toggle
            const menuToggle = document.getElementById('menuToggle');
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('mainContent');
            
            if (menuToggle) {
                menuToggle.addEventListener('click', function() {
                    sidebar.classList.toggle('collapsed');
                    mainContent.classList.toggle('expanded');
                });
            }

            // Setup tab navigation
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const tabName = this.getAttribute('data-tab');
                    showTab(tabName);
                });
            });

            // Setup analytics tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabName = this.getAttribute('data-analytics-tab');
                    if (tabName) {
                        showAnalyticsTab(tabName);
                    }
                });
            });

            // Setup Add Barber button
            document.getElementById('addBarberBtn').addEventListener('click', function() {
                showAddBarberModal();
            });

            // Setup Reset Database button
            document.getElementById('resetDbBtn').addEventListener('click', function() {
                resetDatabase();
            });

            // Setup Logout button
            document.getElementById('logoutBtn').addEventListener('click', function(e) {
                e.preventDefault();
                logout();
            });

            // Setup Refresh Barbers button
            document.getElementById('refreshBarbersBtn').addEventListener('click', async function() {
                console.log('Refresh button clicked');
                await loadBarbers();
            });

            // Setup barber action buttons (delegated event handling)
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('block-barber-btn')) {
                    const barberId = e.target.getAttribute('data-barber-id');
                    showBlockBarberModal(barberId);
                } else if (e.target.classList.contains('unblock-barber-btn')) {
                    const barberId = e.target.getAttribute('data-barber-id');
                    unblockBarber(barberId);
                } else if (e.target.classList.contains('edit-barber-btn')) {
                    const barberId = e.target.getAttribute('data-barber-id');
                    editBarber(barberId);
                } else if (e.target.classList.contains('delete-barber-btn')) {
                    const barberId = e.target.getAttribute('data-barber-id');
                    deleteBarber(barberId);
                } else if (e.target.classList.contains('update-photo-btn')) {
                    const barberId = e.target.getAttribute('data-barber-id');
                    updateBarberPhoto(barberId);
                }
            });
        }

        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.add('active');
            
            // Find and activate the clicked link
            const activeLink = document.querySelector(`[data-tab="${tabName}"]`);
            if (activeLink) {
                activeLink.classList.add('active');
            }
        }

        function showAnalyticsTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.add('active');
            
            // Find and activate the clicked tab
            const activeTab = document.querySelector(`[data-analytics-tab="${tabName}"]`);
            if (activeTab) {
                activeTab.classList.add('active');
            }
            
            switch(tabName) {
                case 'daily': loadDailyAnalysis(); break;
                case 'weekly': loadWeeklyAnalysis(); break;
                case 'revenue': loadRevenueAnalytics(); break;
            }
        }

        function changePeriod() {
            currentPeriod = document.getElementById('periodSelector').value;
            loadDashboardData();
        }

        async function loadDashboardData() {
            try {
                console.log('Loading dashboard data for period:', currentPeriod);
                const response = await fetch(`/api/analytics/dashboard?period=${currentPeriod}`);
                
                console.log('Dashboard response status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Dashboard API Error:', errorText);
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Dashboard data:', data);
                
                if (data.success && data.data) {
                    updateDashboardCards(data.data);
                    updateTrendChart(data.data);
                    updateServiceChart(data.data);
                    updateTopBarbersTable(data.data.barberPerformance || []);
                } else {
                    throw new Error(data.message || 'Failed to load dashboard data');
                }
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                // Show fallback data or error message
                const elements = ['totalBookings', 'totalRevenue', 'activeBarbers', 'totalCustomers'];
                elements.forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.textContent = 'Error';
                    }
                });
            }
        }

        function updateDashboardCards(data) {
            document.getElementById('totalBookings').textContent = data.bookingStats.total_bookings || 0;
            document.getElementById('totalRevenue').textContent = `KES ${(data.revenueStats.total_revenue || 0).toLocaleString()}`;
            document.getElementById('activeBarbers').textContent = data.bookingStats.active_barbers || 0;
            document.getElementById('totalCustomers').textContent = data.customerMetrics.unique_customers || 0;
        }

        function updateTrendChart(data) {
            const ctx = document.getElementById('trendChart').getContext('2d');
            
            if (charts.trendChart) {
                charts.trendChart.destroy();
            }
            
            charts.trendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.dailyTrends.map(item => item.date),
                    datasets: [
                        {
                            label: 'Revenue (KES)',
                            data: data.dailyTrends.map(item => item.revenue),
                            borderColor: '#3498db',
                            backgroundColor: 'rgba(52, 152, 219, 0.1)',
                            yAxisID: 'y'
                        },
                        {
                            label: 'Bookings',
                            data: data.dailyTrends.map(item => item.bookings),
                            borderColor: '#e74c3c',
                            backgroundColor: 'rgba(231, 76, 60, 0.1)',
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { type: 'linear', display: true, position: 'left', title: { display: true, text: 'Revenue (KES)' } },
                        y1: { type: 'linear', display: true, position: 'right', title: { display: true, text: 'Bookings' }, grid: { drawOnChartArea: false } }
                    }
                }
            });
        }

        function updateServiceChart(data) {
            const ctx = document.getElementById('serviceChart').getContext('2d');
            
            if (charts.serviceChart) {
                charts.serviceChart.destroy();
            }
            
            charts.serviceChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: data.serviceBreakdown.map(item => item.service_type),
                    datasets: [{
                        data: data.serviceBreakdown.map(item => item.revenue),
                        backgroundColor: ['#3498db', '#e74c3c', '#2ecc71', '#f39c12', '#9b59b6']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        function updateTopBarbersTable(barbers) {
            const tbody = document.getElementById('topBarbersBody');
            tbody.innerHTML = '';
            
            barbers.forEach(barber => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${escapeHtml(barber.name || '')}</td>
                    <td>${escapeHtml(barber.identity_badge_number || '')}</td>
                    <td>${escapeHtml(barber.period_bookings || '0')}</td>
                    <td>KES ${escapeHtml((barber.period_revenue || 0).toLocaleString())}</td>
                    <td>KES ${escapeHtml((barber.average_service_price || 0).toLocaleString())}</td>
                `;
            });
        }

        async function loadDailyAnalysis() {
            try {
                const response = await fetch('/api/analytics/daily-analysis');
                const data = await response.json();
                
                if (data.success) {
                    updateDailyChart(data.data);
                }
            } catch (error) {
                console.error('Error loading daily analysis:', error);
            }
        }

        function updateDailyChart(data) {
            const ctx = document.getElementById('dailyChart').getContext('2d');
            
            if (charts.dailyChart) {
                charts.dailyChart.destroy();
            }
            
            charts.dailyChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.dailyAnalysis.map(item => item.date),
                    datasets: [
                        {
                            label: 'Bookings',
                            data: data.dailyAnalysis.map(item => item.total_bookings),
                            backgroundColor: '#3498db'
                        },
                        {
                            label: 'Revenue (KES)',
                            data: data.dailyAnalysis.map(item => item.daily_revenue),
                            backgroundColor: '#2ecc71',
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { title: { display: true, text: 'Bookings' } },
                        y1: { position: 'right', title: { display: true, text: 'Revenue (KES)' }, grid: { drawOnChartArea: false } }
                    }
                }
            });
        }

        async function loadWeeklyAnalysis() {
            try {
                const response = await fetch('/api/analytics/weekly-analysis');
                const data = await response.json();
                
                if (data.success) {
                    updateWeeklyChart(data.data);
                }
            } catch (error) {
                console.error('Error loading weekly analysis:', error);
            }
        }

        function updateWeeklyChart(data) {
            const ctx = document.getElementById('weeklyChart').getContext('2d');
            
            if (charts.weeklyChart) {
                charts.weeklyChart.destroy();
            }
            
            charts.weeklyChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.weeklyAnalysis.map(item => `Week ${item.week}`),
                    datasets: [
                        {
                            label: 'Bookings',
                            data: data.weeklyAnalysis.map(item => item.total_bookings),
                            borderColor: '#3498db',
                            backgroundColor: 'rgba(52, 152, 219, 0.1)'
                        },
                        {
                            label: 'Revenue (KES)',
                            data: data.weeklyAnalysis.map(item => item.weekly_revenue),
                            borderColor: '#e74c3c',
                            backgroundColor: 'rgba(231, 76, 60, 0.1)'
                        }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        async function loadRevenueAnalytics() {
            try {
                const response = await fetch('/api/analytics/revenue');
                const data = await response.json();
                
                if (data.success) {
                    updatePaymentChart(data.data);
                }
            } catch (error) {
                console.error('Error loading revenue analytics:', error);
            }
        }

        function updatePaymentChart(data) {
            const ctx = document.getElementById('paymentChart').getContext('2d');
            
            if (charts.paymentChart) {
                charts.paymentChart.destroy();
            }
            
            charts.paymentChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: data.paymentMethodBreakdown.map(item => item.payment_method.toUpperCase()),
                    datasets: [{
                        data: data.paymentMethodBreakdown.map(item => item.total_revenue),
                        backgroundColor: ['#3498db', '#e74c3c', '#2ecc71', '#f39c12']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        async function loadBarbers() {
            const activeTbody = document.getElementById('barbersBody');
            const blockedTbody = document.getElementById('blockedBarbersBody');
            
            if (!activeTbody || !blockedTbody) {
                console.error('Table bodies not found');
                return;
            }
            
            // Show loading state for both tables
            activeTbody.innerHTML = '<tr><td colspan="8">Loading active barbers...</td></tr>';
            blockedTbody.innerHTML = '<tr><td colspan="7">Loading blocked barbers...</td></tr>';
            
            try {
                console.log('Fetching barbers from API...');
                const response = await fetch('/api/barbers');
                
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('API Error Response:', errorText);
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                // Debug: Log the API response
                console.log('API Response:', data);
                console.log('Barbers data:', data.barbers);
                
                if (data.success && data.barbers && Array.isArray(data.barbers)) {
                    console.log('Total barbers found:', data.barbers.length);
                    
                    // Separate active and blocked barbers - handle both string and number types
                    console.log('🔍 Debug: Raw barber data with is_blocked values:');
                    data.barbers.forEach(barber => {
                        console.log(`- ${barber.name}: is_blocked = ${barber.is_blocked} (type: ${typeof barber.is_blocked})`);
                    });
                    
                    // Fix: Use strict comparison for filtering
                    const activeBarbers = data.barbers.filter(barber => {
                        const isBlocked = barber.is_blocked;
                        // A barber is active if is_blocked is 0, false, null, or undefined
                        const isActive = isBlocked === 0 || isBlocked === false || isBlocked === null || isBlocked === undefined;
                        console.log(`Filtering ${barber.name}: is_blocked=${isBlocked}, isActive=${isActive}`);
                        return isActive;
                    });
                    
                    const blockedBarbers = data.barbers.filter(barber => {
                        const isBlocked = barber.is_blocked;
                        // A barber is blocked if is_blocked is 1 or true
                        const isBlockedResult = isBlocked === 1 || isBlocked === true;
                        console.log(`Filtering ${barber.name}: is_blocked=${isBlocked}, isBlocked=${isBlockedResult}`);
                        return isBlockedResult;
                    });
                    
                    console.log('Active barbers:', activeBarbers);
                    console.log('Blocked barbers:', blockedBarbers);
                    
                    updateActiveBarbersTable(activeBarbers);
                    updateBlockedBarbersTable(blockedBarbers);
                } else {
                    console.log('No barbers found or API error');
                    // Show message if no barbers found
                    activeTbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 2rem; color: #666;">No barbers found. Add your first barber using the "Add Barber" button above.</td></tr>';
                    blockedTbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 2rem; color: #666;">No blocked barbers found.</td></tr>';
                }
            } catch (error) {
                console.error('Error loading barbers:', error);
                // Show error message in tables
                activeTbody.innerHTML = `<tr><td colspan="8" style="text-align: center; padding: 2rem; color: #dc3545;">Error loading barbers: ${error.message}. Please refresh the page.</td></tr>`;
                blockedTbody.innerHTML = `<tr><td colspan="7" style="text-align: center; padding: 2rem; color: #dc3545;">Error loading blocked barbers: ${error.message}. Please refresh the page.</td></tr>`;
            }
        }



        async function loadBookings() {
            try {
                // Show current/future bookings by default, or all history when toggled
                const showCompletedParam = showCompleted ? 'true' : 'false';
                console.log('🔍 Loading bookings with showCompleted:', showCompletedParam);
                
                const response = await fetch(`/api/bookings?limit=20&show_completed=${showCompletedParam}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('🔍 Bookings API response:', data);
                
                if (data.success) {
                    console.log('🔍 Bookings data:', data.bookings);
                    updateBookingsTable(data.bookings || []);
                    updateBookingStats(data.bookings || []);
                } else {
                    throw new Error(data.message || 'Failed to load bookings');
                }
            } catch (error) {
                console.error('Error loading bookings:', error);
                const tbody = document.getElementById('bookingsBody');
                tbody.innerHTML = `<tr><td colspan="7" style="text-align: center; padding: 2rem; color: #dc3545;">Error loading bookings: ${error.message}</td></tr>`;
            }
        }

        function updateBookingStats(bookings) {
            const pending = bookings.filter(b => b.status === 'pending').length;
            const inProgress = bookings.filter(b => b.status === 'in_progress').length;
            const cancelled = bookings.filter(b => b.status === 'cancelled').length;
            
            // Safely update stats elements if they exist
            const pendingElement = document.getElementById('pendingBookings');
            const activeElement = document.getElementById('activeBookings');
            const cancelledElement = document.getElementById('cancelledBookings');
            
            if (pendingElement) pendingElement.textContent = pending;
            if (activeElement) activeElement.textContent = inProgress;
            if (cancelledElement) cancelledElement.textContent = cancelled;
        }

        function updateBookingsTable(bookings) {
            console.log('🔍 updateBookingsTable called with:', bookings);
            const tbody = document.getElementById('bookingsBody');
            tbody.innerHTML = '';
            
            if (bookings.length === 0) {
                const message = showCompleted ? 
                    'No bookings found in history' : 
                    'No current or future bookings found';
                console.log('🔍 No bookings found, showing message:', message);
                tbody.innerHTML = `<tr><td colspan="7" style="text-align: center; padding: 2rem; color: #6c757d;">${message}</td></tr>`;
                return;
            }
            
            console.log('🔍 Processing', bookings.length, 'bookings');
            
            bookings.forEach((booking, index) => {
                console.log(`🔍 Processing booking ${index + 1}:`, booking);
                const row = tbody.insertRow();
                const statusClass = booking.status === 'pending' ? 'warning' : 
                                  booking.status === 'in_progress' ? 'success' : 
                                  booking.status === 'cancelled' ? 'danger' : 'secondary';
                
                const rowHtml = `
                    <td>
                        <div class="customer-info">
                            <strong>${escapeHtml(booking.customer_name || '')}</strong>
                            <small class="text-muted">${escapeHtml(booking.customer_phone || '')}</small>
                        </div>
                    </td>
                    <td>${escapeHtml(booking.service_type || '')}</td>
                    <td>${escapeHtml(new Date(booking.preferred_datetime).toLocaleDateString() + ' ' + new Date(booking.preferred_datetime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}))}</td>
                    <td>${escapeHtml(booking.barber_name || 'Unassigned')}</td>
                    <td><strong>KES ${escapeHtml((booking.service_price || 0).toLocaleString())}</strong></td>
                    <td><span class="badge badge-${statusClass}">${escapeHtml(booking.status || '')}</span></td>
                    <td>
                        <div class="btn-group" role="group">
                            ${booking.payment_status !== 'completed' ? 
                                `<button class="btn btn-sm btn-outline-primary" data-action="record-payment" data-booking-id="${booking.id}" title="Record Payment">
                                    💰
                                </button>` : ''
                            }
                            ${booking.status !== 'cancelled' && booking.status !== 'completed' ? 
                                `<button class="btn btn-sm btn-outline-warning" data-action="reschedule-booking" data-booking-id="${booking.id}" title="Reschedule">
                                    🕐
                                </button>` : ''
                            }
                            ${booking.status !== 'cancelled' ? 
                                `<button class="btn btn-sm btn-outline-danger" data-action="cancel-booking" data-booking-id="${booking.id}" title="Cancel">
                                    ❌
                                </button>` : ''
                            }
                            <button class="btn btn-sm btn-outline-info" data-action="view-booking" data-booking-id="${booking.id}" title="View Details">
                                👁️
                            </button>
                        </div>
                    </td>
                `;
                
                console.log(`🔍 Row HTML for booking ${index + 1}:`, rowHtml);
                row.innerHTML = rowHtml;
            });
            
            console.log('🔍 Table update complete. Total rows:', tbody.rows.length);
        }

        async function loadPayments() {
            try {
                const response = await fetch('/api/payment-management');
                if (response.ok) {
                    const data = await response.json();
                    console.log('🔍 Payment API response:', data);
                    
                    // Handle different response structures
                    if (data.payments) {
                        paymentsData = data.payments;
                    } else if (Array.isArray(data)) {
                        paymentsData = data;
                    } else if (data.data && Array.isArray(data.data)) {
                        paymentsData = data.data;
                    } else {
                        console.warn('⚠️ Unexpected payment data structure:', data);
                        paymentsData = [];
                    }
                    
                    displayPayments(paymentsData);
                    updatePaymentStats();
                } else {
                    throw new Error('Failed to load payments');
                }
            } catch (error) {
                console.error('Error loading payments:', error);
                paymentsData = [];
                document.getElementById('paymentsBody').innerHTML = '<tr><td colspan="8">❌ Error loading payments: ' + error.message + '</td></tr>';
            }
        }

        function displayPayments(payments) {
            const tbody = document.getElementById('paymentsBody');
            if (!payments || payments.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8">No payments found</td></tr>';
                return;
            }

            tbody.innerHTML = payments.map(payment => `
                <tr>
                    <td>#${payment.booking_id}</td>
                    <td>${payment.customer_name || 'N/A'}</td>
                    <td>${payment.service_type || 'N/A'}</td>
                    <td>KSh ${payment.amount}</td>
                    <td>${payment.payment_method}</td>
                    <td>
                        <span class="badge ${payment.status === 'received' ? 'badge-success' : 'badge-warning'}">
                            ${payment.status === 'received' ? '✅ Received' : '⏳ Pending'}
                        </span>
                    </td>
                    <td>${new Date(payment.created_at).toLocaleDateString()}</td>
                    <td>
                        ${payment.status === 'pending' ? 
                            `<button onclick="markPaymentReceived(${payment.id})" class="btn btn-success btn-sm">✅ Mark Received</button>` :
                            `<button onclick="markPaymentPending(${payment.id})" class="btn btn-warning btn-sm">⏳ Mark Pending</button>`
                        }
                        <button onclick="viewPaymentDetails(${payment.id})" class="btn btn-info btn-sm">👁️ View</button>
                    </td>
                </tr>
            `).join('');
        }

        function updatePaymentStats() {
            const totalRevenue = paymentsData.reduce((sum, p) => sum + p.amount, 0);
            const pendingCount = paymentsData.filter(p => p.status === 'pending').length;
            const receivedCount = paymentsData.filter(p => p.status === 'received').length;

            document.getElementById('totalRevenuePayments').textContent = `KSh ${totalRevenue.toFixed(2)}`;
            document.getElementById('pendingPayments').textContent = pendingCount;
            document.getElementById('receivedPayments').textContent = receivedCount;
        }

        async function markPaymentReceived(paymentId) {
            try {
                const response = await fetch(`/api/payment-management/${paymentId}/mark-received`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (response.ok) {
                    await loadPayments();
                    alert('✅ Payment marked as received!');
                } else {
                    throw new Error('Failed to update payment');
                }
            } catch (error) {
                console.error('Error updating payment:', error);
                alert('❌ Error updating payment: ' + error.message);
            }
        }

        async function markPaymentPending(paymentId) {
            try {
                const response = await fetch(`/api/payment-management/${paymentId}/mark-pending`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (response.ok) {
                    await loadPayments();
                    alert('✅ Payment marked as pending!');
                } else {
                    throw new Error('Failed to update payment');
                }
            } catch (error) {
                console.error('Error updating payment:', error);
                alert('❌ Error updating payment: ' + error.message);
            }
        }

        function viewPaymentDetails(paymentId) {
            const payment = paymentsData.find(p => p.id === paymentId);
            if (!payment) return;

            const modalHtml = `
                <div class="modal-overlay" id="paymentDetailsModal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>Payment Details</h3>
                            <button onclick="closeModal('paymentDetailsModal')" class="close-btn">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="detail-row">
                                <strong>Booking ID:</strong> #${payment.booking_id}
                            </div>
                            <div class="detail-row">
                                <strong>Customer:</strong> ${payment.customer_name || 'N/A'}
                            </div>
                            <div class="detail-row">
                                <strong>Service:</strong> ${payment.service_type || 'N/A'}
                            </div>
                            <div class="detail-row">
                                <strong>Amount:</strong> KSh ${payment.amount}
                            </div>
                            <div class="detail-row">
                                <strong>Payment Method:</strong> ${payment.payment_method}
                            </div>
                            <div class="detail-row">
                                <strong>Status:</strong> 
                                <span class="badge ${payment.status === 'received' ? 'badge-success' : 'badge-warning'}">
                                    ${payment.status === 'received' ? '✅ Received' : '⏳ Pending'}
                                </span>
                            </div>
                            <div class="detail-row">
                                <strong>Created:</strong> ${new Date(payment.created_at).toLocaleString()}
                            </div>
                            ${payment.payment_received_at ? 
                                `<div class="detail-row">
                                    <strong>Received:</strong> ${new Date(payment.payment_received_at).toLocaleString()}
                                </div>` : ''
                            }
                            ${payment.payment_notes ? 
                                `<div class="detail-row">
                                    <strong>Notes:</strong> ${payment.payment_notes}
                                </div>` : ''
                            }
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        function setupPaymentEventListeners() {
            // Search functionality
            const searchInput = document.getElementById('paymentSearch');
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    const query = this.value.toLowerCase();
                    const filtered = paymentsData.filter(payment => 
                        payment.customer_name?.toLowerCase().includes(query) ||
                        payment.service_type?.toLowerCase().includes(query) ||
                        payment.booking_id.toString().includes(query)
                    );
                    displayPayments(filtered);
                });
            }

            // Status filter
            const statusFilter = document.getElementById('paymentStatusFilter');
            if (statusFilter) {
                statusFilter.addEventListener('change', function() {
                    const status = this.value;
                    const filtered = status ? paymentsData.filter(p => p.status === status) : paymentsData;
                    displayPayments(filtered);
                });
            }
        }

        // ========================================
        // CLIENT MANAGEMENT FUNCTIONS
        // ========================================

        async function initializeClientManagement() {
            console.log('🔧 Initializing client management...');
            await loadClients();
            setupClientEventListeners();
        }

        async function loadClients() {
            try {
                const response = await fetch('/api/clients');
                if (response.ok) {
                    clientsData = await response.json();
                    displayClients(clientsData);
                    updateClientStats();
                } else {
                    throw new Error('Failed to load clients');
                }
            } catch (error) {
                console.error('Error loading clients:', error);
                document.getElementById('clientsBody').innerHTML = '<tr><td colspan="7">❌ Error loading clients</td></tr>';
            }
        }

        function displayClients(clients) {
            const tbody = document.getElementById('clientsBody');
            if (!clients || clients.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7">No clients found</td></tr>';
                return;
            }

            tbody.innerHTML = clients.map(client => `
                <tr>
                    <td>${client.name}</td>
                    <td>${client.phone}</td>
                    <td>${client.email || 'N/A'}</td>
                    <td>${client.total_bookings || 0}</td>
                    <td>KSh ${(client.total_spent || 0).toFixed(2)}</td>
                    <td>${client.last_booking_date ? new Date(client.last_booking_date).toLocaleDateString() : 'Never'}</td>
                    <td>
                        <button onclick="viewClientDetails(${client.id})" class="btn btn-info btn-sm">👁️ View</button>
                        <button onclick="editClientPreferences(${client.id})" class="btn btn-warning btn-sm">✏️ Edit</button>
                    </td>
                </tr>
            `).join('');
        }

        function updateClientStats() {
            const totalClients = clientsData.length;
            const activeClients = clientsData.filter(c => c.is_active).length;
            const repeatBookings = clientsData.filter(c => (c.total_bookings || 0) > 1).length;

            document.getElementById('totalClients').textContent = totalClients;
            document.getElementById('activeClients').textContent = activeClients;
            document.getElementById('repeatBookings').textContent = repeatBookings;
        }

        function viewClientDetails(clientId) {
            const client = clientsData.find(c => c.id === clientId);
            if (!client) return;

            const modalHtml = `
                <div class="modal-overlay" id="clientDetailsModal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>Client Details</h3>
                            <button onclick="closeModal('clientDetailsModal')" class="close-btn">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="detail-row">
                                <strong>Name:</strong> ${client.name}
                            </div>
                            <div class="detail-row">
                                <strong>Phone:</strong> ${client.phone}
                            </div>
                            <div class="detail-row">
                                <strong>Email:</strong> ${client.email || 'N/A'}
                            </div>
                            <div class="detail-row">
                                <strong>Address:</strong> ${client.address || 'N/A'}
                            </div>
                            <div class="detail-row">
                                <strong>Total Bookings:</strong> ${client.total_bookings || 0}
                            </div>
                            <div class="detail-row">
                                <strong>Total Spent:</strong> KSh ${(client.total_spent || 0).toFixed(2)}
                            </div>
                            <div class="detail-row">
                                <strong>Last Booking:</strong> ${client.last_booking_date ? new Date(client.last_booking_date).toLocaleDateString() : 'Never'}
                            </div>
                            <div class="detail-row">
                                <strong>Favorite Service:</strong> ${client.favorite_service || 'N/A'}
                            </div>
                            <div class="detail-row">
                                <strong>Preferred Barber:</strong> ${client.preferred_barber_name || 'N/A'}
                            </div>
                            ${client.notes ? 
                                `<div class="detail-row">
                                    <strong>Notes:</strong> ${client.notes}
                                </div>` : ''
                            }
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        function editClientPreferences(clientId) {
            const client = clientsData.find(c => c.id === clientId);
            if (!client) return;

            const modalHtml = `
                <div class="modal-overlay" id="editClientModal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>Edit Client Preferences</h3>
                            <button onclick="closeModal('editClientModal')" class="close-btn">&times;</button>
                        </div>
                        <div class="modal-body">
                            <form id="editClientForm">
                                <div class="form-group">
                                    <label>Preferred Service:</label>
                                    <input type="text" id="preferredService" value="${client.preferred_service || ''}" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label>Preferred Barber:</label>
                                    <input type="text" id="preferredBarber" value="${client.preferred_barber_name || ''}" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label>Notes:</label>
                                    <textarea id="clientNotes" class="form-control" rows="3">${client.notes || ''}</textarea>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button onclick="saveClientPreferences(${client.id})" class="btn btn-success">💾 Save Changes</button>
                            <button onclick="closeModal('editClientModal')" class="btn btn-secondary">❌ Cancel</button>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        async function saveClientPreferences(clientId) {
            try {
                const form = document.getElementById('editClientForm');
                const data = {
                    preferred_service: document.getElementById('preferredService').value,
                    preferred_barber_name: document.getElementById('preferredBarber').value,
                    notes: document.getElementById('clientNotes').value
                };

                const response = await fetch(`/api/clients/${clientId}/preferences`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    await loadClients();
                    closeModal('editClientModal');
                    alert('✅ Client preferences updated successfully!');
                } else {
                    throw new Error('Failed to update client preferences');
                }
            } catch (error) {
                console.error('Error updating client preferences:', error);
                alert('❌ Error updating client preferences: ' + error.message);
            }
        }

        function setupClientEventListeners() {
            // Search functionality
            const searchInput = document.getElementById('clientSearch');
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    const query = this.value.toLowerCase();
                    const filtered = clientsData.filter(client => 
                        client.name.toLowerCase().includes(query) ||
                        client.phone.includes(query) ||
                        (client.email && client.email.toLowerCase().includes(query))
                    );
                    displayClients(filtered);
                });
            }

            // Status filter
            const statusFilter = document.getElementById('clientStatusFilter');
            if (statusFilter) {
                statusFilter.addEventListener('change', function() {
                    const status = this.value;
                    const filtered = status ? clientsData.filter(c => 
                        status === 'active' ? c.is_active : !c.is_active
                    ) : clientsData;
                    displayClients(filtered);
                });
            }
        }

        // ========================================
        // UTILITY FUNCTIONS
        // ========================================

        // Logout function
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('adminToken');
                localStorage.removeItem('adminUser');
                window.location.href = '/login';
            }
        }

        function closeModal(modalId) {
            console.log('🔧 closeModal called with:', modalId);
            const modal = document.getElementById(modalId);
            console.log('🔧 Modal element found:', modal);
            if (modal) {
                modal.remove();
                console.log('🔧 Modal removed');
            } else {
                console.log('🔧 Modal not found');
            }
        }

        // ===== BOOKING MANAGEMENT FUNCTIONS =====
        
        // View booking details
        async function viewBookingDetails(bookingId) {
            try {
                const response = await fetch(`/api/bookings/${bookingId}`);
                if (!response.ok) throw new Error('Failed to fetch booking details');
                
                const data = await response.json();
                if (!data.success) throw new Error(data.message);
                
                const booking = data.booking;
                
                // Create detailed view modal
                const modalHtml = `
                    <div class="modal-overlay" id="bookingDetailsModal">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h3>📋 Booking Details</h3>
                                <button onclick="closeModal('bookingDetailsModal')" class="close-btn">&times;</button>
                            </div>
                            <div class="modal-body">
                                <div class="booking-details">
                                    <div class="detail-row">
                                        <strong>Customer:</strong> ${escapeHtml(booking.customer_name)}
                                    </div>
                                    <div class="detail-row">
                                        <strong>Phone:</strong> ${escapeHtml(booking.customer_phone || 'N/A')}
                                    </div>
                                    <div class="detail-row">
                                        <strong>Email:</strong> ${escapeHtml(booking.customer_email || 'N/A')}
                                    </div>
                                    <div class="detail-row">
                                        <strong>Service:</strong> ${escapeHtml(booking.service_type)}
                                    </div>
                                    <div class="detail-row">
                                        <strong>Date & Time:</strong> ${new Date(booking.preferred_datetime).toLocaleString()}
                                    </div>
                                    <div class="detail-row">
                                        <strong>Address:</strong> ${escapeHtml(booking.address)}
                                    </div>
                                    <div class="detail-row">
                                        <strong>Barber:</strong> ${escapeHtml(booking.barber_name)}
                                    </div>
                                    <div class="detail-row">
                                        <strong>Amount:</strong> KES ${(booking.service_price || 0).toLocaleString()}
                                    </div>
                                    <div class="detail-row">
                                        <strong>Status:</strong> <span class="status-badge status-${escapeHtml(booking.status)}">${escapeHtml(booking.status)}</span>
                                    </div>
                                    <div class="detail-row">
                                        <strong>Payment:</strong> <span class="status-badge status-${escapeHtml(booking.payment_status)}">${escapeHtml(booking.payment_status)}</span>
                                    </div>
                                    ${booking.notes ? `<div class="detail-row"><strong>Notes:</strong> ${escapeHtml(booking.notes)}</div>` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                
            } catch (error) {
                console.error('Error viewing booking details:', error);
                alert('❌ Error loading booking details: ' + error.message);
            }
        }

        // Reschedule booking
        async function rescheduleBooking(bookingId) {
            try {
                console.log('🔍 Reschedule function called with booking ID:', bookingId);
                
                const response = await fetch(`/api/bookings/${bookingId}`);
                console.log('🔍 API response status:', response.status);
                
                if (!response.ok) throw new Error('Failed to fetch booking details');
                
                const data = await response.json();
                console.log('🔍 API response data:', data);
                
                if (!data.success) throw new Error(data.message);
                
                const booking = data.booking;
                console.log('🔍 Booking data:', booking);
                
                // Get new date/time from user
                const currentDateTime = new Date(booking.preferred_datetime).toLocaleString();
                const defaultDateTime = new Date(booking.preferred_datetime).toISOString().slice(0, 16).replace('T', ' ');
                
                console.log('🔍 Current datetime:', currentDateTime);
                console.log('🔍 Default datetime for input:', defaultDateTime);
                
                const newDateTime = prompt(
                    'Enter new date and time (YYYY-MM-DD HH:MM):\n\nCurrent: ' + currentDateTime,
                    defaultDateTime
                );
                
                console.log('🔍 User entered new datetime:', newDateTime);
                
                if (!newDateTime) {
                    console.log('🔍 User cancelled reschedule');
                    return;
                }
                
                // Validate new datetime
                const newDate = new Date(newDateTime);
                if (isNaN(newDate.getTime())) {
                    alert('❌ Invalid date format. Please use YYYY-MM-DD HH:MM');
                    return;
                }
                
                console.log('🔍 Validated new date:', newDate);
                
                // Check if new time is within working hours
                const workingHoursCheck = await fetch('/api/working-hours/check', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ datetime: newDate.toISOString() })
                });
                
                const workingHoursData = await workingHoursCheck.json();
                console.log('🔍 Working hours check result:', workingHoursData);
                
                if (!workingHoursData.success || !workingHoursData.result.isOpen) {
                    alert('❌ New time is outside working hours: ' + (workingHoursData.result?.reason || 'Unknown reason'));
                    return;
                }
                
                // Update booking with new datetime
                const updateResponse = await fetch(`/api/bookings/${bookingId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        preferred_datetime: newDate.toISOString(),
                        notes: (booking.notes || '') + '\n[Rescheduled from ' + new Date(booking.preferred_datetime).toLocaleString() + ']'
                    })
                });
                
                console.log('🔍 Update response status:', updateResponse.status);
                
                if (!updateResponse.ok) throw new Error('Failed to update booking');
                
                const updateData = await updateResponse.json();
                console.log('🔍 Update response data:', updateData);
                
                if (updateData.success) {
                    alert('✅ Booking rescheduled successfully!');
                    await loadBookings(); // Refresh the table
                } else {
                    throw new Error(updateData.message);
                }
                
            } catch (error) {
                console.error('❌ Error rescheduling booking:', error);
                alert('❌ Error rescheduling booking: ' + error.message);
            }
        }



        // Cancel booking
        async function cancelBooking(bookingId) {
            try {
                const cancellationReason = prompt('Please provide a reason for cancellation:');
                if (!cancellationReason) return;
                
                if (cancellationReason.length < 5) {
                    alert('❌ Cancellation reason must be at least 5 characters long');
                    return;
                }
                
                const response = await fetch(`/api/bookings/${bookingId}/cancel`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        cancellation_reason: cancellationReason,
                        cancelled_by: 'Admin'
                    })
                });
                
                if (!response.ok) throw new Error('Failed to cancel booking');
                
                const data = await response.json();
                if (data.success) {
                    alert('✅ Booking cancelled successfully!');
                    await loadBookings(); // Refresh the table
                } else {
                    throw new Error(data.message);
                }
                
            } catch (error) {
                console.error('Error cancelling booking:', error);
                alert('❌ Error cancelling booking: ' + error.message);
            }
        }

        // Record payment for a booking
        async function recordPayment(bookingId) {
            try {
                console.log('🔍 Record payment function called with booking ID:', bookingId);
                
                // Get booking details first
                const response = await fetch(`/api/bookings/${bookingId}`);
                console.log('🔍 API response status:', response.status);
                
                if (!response.ok) throw new Error('Failed to fetch booking details');
                
                const data = await response.json();
                console.log('🔍 API response data:', data);
                
                if (!data.success) throw new Error(data.message);
                
                const booking = data.booking;
                console.log('🔍 Booking data for payment:', booking);
                
                // Check if already paid
                if (booking.payment_status === 'paid') {
                    alert('❌ This booking is already marked as paid!');
                    return;
                }
                
                // Create payment recording modal
                const modalHtml = `
                    <div class="modal-overlay" id="recordPaymentModal">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h3>💰 Record Payment</h3>
                                <button class="close-btn" data-modal-id="recordPaymentModal">&times;</button>
                            </div>
                            <div class="modal-body">
                                <div class="payment-form">
                                    <div class="form-group">
                                        <label><strong>Customer:</strong></label>
                                        <span>${escapeHtml(booking.customer_name)}</span>
                                    </div>
                                    <div class="form-group">
                                        <label><strong>Service:</strong></label>
                                        <span>${escapeHtml(booking.service_type)}</span>
                                    </div>
                                    <div class="form-group">
                                        <label><strong>Amount Due:</strong></label>
                                        <span class="amount">KES ${(booking.service_price || 0).toLocaleString()}</span>
                                    </div>
                                    <div class="form-group">
                                        <label for="paymentMethod"><strong>Payment Method:</strong></label>
                                        <select id="paymentMethod" class="form-control">
                                            <option value="cash">💵 Cash</option>
                                            <option value="mpesa">📱 M-Pesa</option>
                                            <option value="card">💳 Card</option>
                                        </select>
                                    </div>
                                    <div class="form-group" id="mpesaPhoneGroup" style="display: none;">
                                        <label for="mpesaPhone"><strong>M-Pesa Phone Number:</strong></label>
                                        <input type="tel" id="mpesaPhone" class="form-control" placeholder="07XX XXX XXX">
                                    </div>
                                    <div class="form-group">
                                        <label for="paymentNotes"><strong>Payment Notes:</strong></label>
                                        <textarea id="paymentNotes" class="form-control" placeholder="Optional notes about the payment..." rows="3"></textarea>
                                    </div>
                                    <div class="form-actions">
                                        <button class="btn btn-secondary" data-modal-id="recordPaymentModal">Cancel</button>
                                        <button class="btn btn-primary" data-action="submit-payment" data-booking-id="${bookingId}">💾 Record Payment</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                
                // Show/hide M-Pesa phone field based on payment method
                const paymentMethod = document.getElementById('paymentMethod');
                const mpesaPhoneGroup = document.getElementById('mpesaPhoneGroup');
                
                paymentMethod.addEventListener('change', function() {
                    if (this.value === 'mpesa') {
                        mpesaPhoneGroup.style.display = 'block';
                    } else {
                        mpesaPhoneGroup.style.display = 'none';
                    }
                });
                
            } catch (error) {
                console.error('Error opening payment modal:', error);
                alert('❌ Error loading booking details: ' + error.message);
            }
        }

        // Submit payment record
        async function submitPayment(bookingId) {
            try {
                const paymentMethod = document.getElementById('paymentMethod').value;
                const mpesaPhone = document.getElementById('mpesaPhone').value;
                const paymentNotes = document.getElementById('paymentNotes').value;
                
                console.log('🔍 Debug: Form values:', {
                    paymentMethod,
                    mpesaPhone,
                    paymentNotes
                });
                
                console.log('🔍 Debug: Raw form values:', {
                    paymentMethod: document.getElementById('paymentMethod').value,
                    mpesaPhone: document.getElementById('mpesaPhone').value,
                    paymentNotes: document.getElementById('paymentNotes').value
                });
                
                // Validate M-Pesa phone if M-Pesa is selected
                if (paymentMethod === 'mpesa' && !mpesaPhone) {
                    alert('❌ Please enter M-Pesa phone number');
                    return;
                }
                
                // Format phone number for Kenya (add +254 if not present)
                let formattedPhone = mpesaPhone;
                if (paymentMethod === 'mpesa' && mpesaPhone) {
                    if (mpesaPhone.startsWith('0')) {
                        formattedPhone = '+254' + mpesaPhone.substring(1);
                    } else if (mpesaPhone.startsWith('254')) {
                        formattedPhone = '+' + mpesaPhone;
                    } else if (!mpesaPhone.startsWith('+')) {
                        formattedPhone = '+254' + mpesaPhone;
                    }
                }
                
                // Get booking details to get the amount
                const bookingResponse = await fetch(`/api/bookings/${bookingId}`);
                if (!bookingResponse.ok) throw new Error('Failed to fetch booking details');
                
                const bookingData = await bookingResponse.json();
                if (!bookingData.success) throw new Error(bookingData.message);
                
                const booking = bookingData.booking;
                
                // Create payment record
                const paymentData = {
                    booking_id: parseInt(bookingId),
                    amount: parseFloat(booking.service_price),
                    payment_method: paymentMethod,
                    phone_number: paymentMethod === 'mpesa' ? formattedPhone : null,
                    customer_notes: paymentNotes
                };
                
                console.log('🔍 Debug: Payment data being sent:', paymentData);
                console.log('🔍 Debug: Booking data:', booking);
                
                const paymentResponse = await fetch('/api/payments', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(paymentData)
                });
                
                if (!paymentResponse.ok) throw new Error('Failed to record payment');
                
                const paymentResult = await paymentResponse.json();
                if (paymentResult.success) {
                    alert('✅ Payment recorded successfully!');
                    closeModal('recordPaymentModal');
                    
                    // Update the booking's payment status locally
                    const bookingRow = document.querySelector(`[data-booking-id="${bookingId}"]`).closest('tr');
                    if (bookingRow) {
                        const paymentStatusCell = bookingRow.querySelector('td:nth-child(8)');
                        if (paymentStatusCell) {
                            paymentStatusCell.innerHTML = '<span class="status-badge status-paid">paid</span>';
                        }
                    }
                    
                    // Add the new payment to the payments table
                    const newPayment = {
                        id: paymentResult.payment.id || Date.now(),
                        booking_id: bookingId,
                        customer_name: booking.customer_name,
                        service_type: booking.service_type,
                        amount: booking.service_price,
                        payment_method: paymentMethod,
                        status: 'received',
                        created_at: new Date().toISOString()
                    };
                    
                    // Add to local payments data
                    paymentsData.push(newPayment);
                    
                    // Refresh both tables
                    await loadBookings();
                    displayPayments(paymentsData);
                    updatePaymentStats();
                    
                    // Show success message
                    showNotification('Payment recorded successfully!', 'success');
                } else {
                    throw new Error(paymentResult.message);
                }
                
            } catch (error) {
                console.error('Error recording payment:', error);
                alert('❌ Error recording payment: ' + error.message);
            }
        }

        // Close modal
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.remove();
            }
        }

        // Safe HTML insertion function
        function safeSetInnerHTML(element, html) {
            if (element) {
                element.innerHTML = html;
            }
        }

        function updateActiveBarbersTable(barbers) {
            const tbody = document.getElementById('barbersBody');
            tbody.innerHTML = '';
            
            if (barbers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 2rem; color: #666;">No active barbers found.</td></tr>';
                return;
            }
            
            barbers.forEach(barber => {
                const row = tbody.insertRow();
                
                // Escape all user data to prevent XSS
                const safeName = escapeHtml(barber.name || '');
                const safeBadge = escapeHtml(barber.identity_badge_number || '');
                const safePhone = escapeHtml(barber.phone || '');
                const safeServices = escapeHtml(barber.total_services || '0');
                const safeEarnings = escapeHtml((barber.total_earnings || 0).toLocaleString());
                const safeId = escapeHtml(barber.id || '');
                const isActive = barber.is_active ? 'Active' : 'Inactive';
                const statusClass = barber.is_active ? 'status-completed' : 'status-cancelled';
                
                // Safe photo handling
                let photoHtml = '';
                if (barber.profile_photo) {
                    photoHtml = `<img src="${escapeHtml(barber.profile_photo)}" alt="Barber photo" style="width: 100%; height: 100%; object-fit: cover;">`;
                } else {
                    photoHtml = `<div style="width: 100%; height: 100%; background: #f8f9fa; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">👨‍💼</div>`;
                }
                
                row.innerHTML = `
                    <td>
                        <div style="width: 50px; height: 50px; border-radius: 50%; overflow: hidden; margin: 0 auto;">
                            ${photoHtml}
                        </div>
                        <button class="update-photo-btn" data-barber-id="${safeId}" class="photo-upload-btn">Update Photo</button>
                    </td>
                    <td>${safeName}</td>
                    <td>${safeBadge}</td>
                    <td>${safePhone}</td>
                    <td>${safeServices}</td>
                    <td>KES ${safeEarnings}</td>
                    <td><span class="status-badge ${statusClass}">${isActive}</span></td>
                    <td>
                        <button class="block-barber-btn" data-barber-id="${safeId}" style="padding: 5px 10px; background: #f39c12; color: white; border: none; border-radius: 3px; cursor: pointer; margin-right: 5px;">Block</button>
                        <button class="edit-barber-btn" data-barber-id="${safeId}" style="padding: 5px 10px; background: #3498db; color: white; border: none; border-radius: 3px; cursor: pointer; margin-right: 5px;">Edit</button>
                        <button class="delete-barber-btn" data-barber-id="${safeId}" style="padding: 5px 10px; background: #e74c3c; color: white; border: none; border-radius: 3px; cursor: pointer;">Delete</button>
                    </td>
                `;
            });
        }

        function getSeverityColor(severity) {
            switch(severity) {
                case 'day-off': return 'info';
                case 'warning': return 'warning';
                case 'suspension': return 'danger';
                case 'permanent': return 'dark';
                default: return 'secondary';
            }
        }

        function updateBlockedBarbersTable(barbers) {
            const tbody = document.getElementById('blockedBarbersBody');
            tbody.innerHTML = '';
            
            if (barbers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="12" style="text-align: center; padding: 2rem; color: #666;">No blocked barbers found.</td></tr>';
                return;
            }
            
            barbers.forEach(barber => {
                const row = tbody.insertRow();
                
                // Escape all user data to prevent XSS
                const safeName = escapeHtml(barber.name || '');
                const safeBadge = escapeHtml(barber.identity_badge_number || '');
                const safePhone = escapeHtml(barber.phone || '');
                const safeId = escapeHtml(barber.id || '');
                const safeBlockReason = escapeHtml(barber.block_reason || 'No reason provided');
                const blockedDate = barber.blocked_at ? new Date(barber.blocked_at).toLocaleDateString() : 'Unknown';
                
                // Enhanced block information
                const blockType = barber.block_type || 'permanent';
                const blockTypeDisplay = blockType === 'temporary' ? 
                    `<span style="color: #f39c12; font-weight: 600;">⏰ Temporary</span>` : 
                    `<span style="color: #e74c3c; font-weight: 600;">🔒 Permanent</span>`;
                
                let durationDisplay = '';
                if (blockType === 'temporary' && barber.block_duration_hours) {
                    const hours = barber.block_duration_hours;
                    let timeText = '';
                    if (hours >= 168) {
                        timeText = `${Math.floor(hours / 168)} week(s)`;
                    } else if (hours >= 24) {
                        timeText = `${Math.floor(hours / 24)} day(s)`;
                    } else {
                        timeText = `${hours} hour(s)`;
                    }
                    durationDisplay = `<span style="color: #3498db; font-weight: 500;">${timeText}</span>`;
                } else {
                    durationDisplay = '<span style="color: #95a5a6;">-</span>';
                }
                
                let expiryDisplay = '';
                if (blockType === 'temporary' && barber.block_expires_at) {
                    const expiryDate = new Date(barber.block_expires_at);
                    const now = new Date();
                    const timeLeft = expiryDate - now;
                    
                    if (timeLeft > 0) {
                        const hoursLeft = Math.floor(timeLeft / (1000 * 60 * 60));
                        const minutesLeft = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
                        expiryDisplay = `<span style="color: #27ae60; font-weight: 500;">${hoursLeft}h ${minutesLeft}m left</span>`;
                    } else {
                        expiryDisplay = '<span style="color: #e74c3c; font-weight: 600;">EXPIRED</span>';
                    }
                } else {
                    expiryDisplay = '<span style="color: #95a5a6;">-</span>';
                }
                
                // Safe photo handling
                let photoHtml = '';
                if (barber.profile_photo) {
                    photoHtml = `<img src="${escapeHtml(barber.profile_photo)}" alt="Barber photo" style="width: 100%; height: 100%; object-fit: cover;">`;
                } else {
                    photoHtml = `<div style="width: 100%; height: 100%; background: #f8f9fa; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">👨‍💼</div>`;
                }
                
                row.innerHTML = `
                    <td>
                        <div style="width: 50px; height: 50px; border-radius: 50%; overflow: hidden; margin: 0 auto;">
                            ${photoHtml}
                        </div>
                    </td>
                    <td>${safeName}</td>
                    <td>${safeBadge}</td>
                    <td>${safePhone}</td>
                    <td><span style="color: #dc3545; font-weight: 500;">${safeBlockReason}</span></td>
                    <td>${blockedDate}</td>
                    <td><span class="badge badge-info">${barber.block_category || 'N/A'}</span></td>
                    <td><span class="badge badge-${getSeverityColor(barber.block_severity)}">${barber.block_severity || 'N/A'}</span></td>
                    <td>${blockTypeDisplay}</td>
                    <td>${durationDisplay}</td>
                    <td>${expiryDisplay}</td>
                    <td>
                        <button class="unblock-barber-btn" data-barber-id="${safeId}" style="padding: 8px 15px; background: #27ae60; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 600;">🔓 Unblock</button>
                    </td>
                `;
            });
        }



        function showAddBarberModal() {
            console.log('showAddBarberModal called');
            // Create modal HTML with Adminator-style design
            const modalHTML = `
                <div id="addBarberModal" class="modal" style="display: block;">
                    <div class="modal-content" style="max-width: 700px; max-height: 90vh; margin: 2% auto; background: white; border-radius: 15px; box-shadow: 0 20px 40px rgba(0,0,0,0.3); animation: modalSlideIn 0.3s ease-out; overflow: hidden;">
                        <div class="modal-header" style="background: #1976d2; color: white; padding: 20px 25px; border-radius: 15px 15px 0 0; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0;">
                            <h3 style="margin: 0; font-size: 20px; font-weight: 600;">Add New Barber</h3>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <button id="cancelModalBtn" style="padding: 8px 16px; background: #e74c3c; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 12px; font-weight: 500;">❌ Cancel</button>
                                <span class="close" id="closeModalBtn" style="color: white; font-size: 24px; cursor: pointer; margin-left: 10px;">&times;</span>
                            </div>
                        </div>
                        <div class="modal-body" style="padding: 30px; max-height: calc(90vh - 80px); overflow-y: auto;">
                            <form id="addBarberForm" enctype="multipart/form-data">
                                <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                                    <div class="control-group">
                                        <label class="control-label" for="barberName">Full Name *</label>
                                        <div class="controls">
                                            <input type="text" id="barberName" name="name" placeholder="Enter barber's full name" class="form-control" required>
                                        </div>
                                    </div>
                                    
                                    <div class="control-group">
                                        <label class="control-label" for="barberPhone">Mobile Number *</label>
                                        <div class="controls">
                                            <input type="tel" id="barberPhone" name="phone" placeholder="+254XXXXXXXXX" class="form-control" required>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                                    <div class="control-group">
                                        <label class="control-label" for="barberEmail">Email Address</label>
                                        <div class="controls">
                                            <input type="email" id="barberEmail" name="email" placeholder="barber@jazzman.com" class="form-control">
                                        </div>
                                    </div>
                                    
                                    <div class="control-group">
                                        <label class="control-label" for="barberBadge">Identity Badge Number *</label>
                                        <div class="controls">
                                            <input type="text" id="barberBadge" name="identity_badge_number" placeholder="e.g., JM001, JB001" class="form-control" required>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="control-group" style="margin-bottom: 20px;">
                                    <label class="control-label" for="barberLocation">Current Location</label>
                                    <div class="controls">
                                        <input type="text" id="barberLocation" name="current_location" placeholder="e.g., Westlands, Nairobi" class="form-control">
                                    </div>
                                </div>
                                
                                <div class="control-group" style="margin-bottom: 20px;">
                                    <label class="control-label" for="barberPhoto">Profile Photo *</label>
                                    <div class="controls">
                                        <input type="file" id="barberPhoto" name="profile_photo" accept="image/*" class="form-control" required>
                                        <small class="help-text">Max size: 5MB. Supported formats: JPG, PNG, GIF</small>
                                    </div>
                                </div>
                                
                                <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 30px;">
                                    <div class="control-group">
                                        <label class="control-label" for="barberStatus">Initial Status</label>
                                        <div class="controls">
                                            <select id="barberStatus" name="is_active" class="form-control">
                                                <option value="1" selected>🟢 Active</option>
                                                <option value="0">🔴 Inactive</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="control-group">
                                        <label class="control-label" for="barberServices">Initial Service Count</label>
                                        <div class="controls">
                                            <input type="number" id="barberServices" name="total_services" min="0" placeholder="0" class="form-control">
                                        </div>
                                    </div>
                                    
                                    <div class="control-group">
                                        <label class="control-label" for="barberEarnings">Initial Earnings (KES)</label>
                                        <div class="controls">
                                            <input type="number" id="barberEarnings" name="total_earnings" min="0" step="0.01" placeholder="0.00" class="form-control">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="form-actions" style="display: flex; gap: 15px; justify-content: flex-end; border-top: 1px solid #eee; padding-top: 20px; margin-top: 20px;">
                                    <button type="button" id="cancelBtn" style="padding: 12px 24px; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 500;">Cancel</button>
                                    <button type="submit" id="submitBarberBtn" style="padding: 12px 30px; background: #27ae60; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 16px;">✅ Add Barber</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;
            
            // Add modal to body
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            console.log('Modal added to DOM');
            
            // Add modal styles if not already present
            if (!document.getElementById('modalStyles')) {
                const modalStyles = document.createElement('style');
                modalStyles.id = 'modalStyles';
                modalStyles.textContent = `
                    .modal {
                        display: block;
                        position: fixed;
                        z-index: 2000;
                        left: 0;
                        top: 0;
                        width: 100%;
                        height: 100%;
                        background-color: rgba(0, 0, 0, 0.5);
                        backdrop-filter: blur(5px);
                        overflow-y: auto;
                        padding: 20px;
                    }
                    @keyframes modalSlideIn {
                        from { transform: translateY(-50px); opacity: 0; }
                        to { transform: translateY(0); opacity: 1; }
                    }
                    .control-group {
                        margin-bottom: 20px;
                    }
                    .control-label {
                        display: block;
                        margin-bottom: 8px;
                        font-weight: 600;
                        color: #333;
                        font-size: 14px;
                    }
                    .controls {
                        position: relative;
                    }
                    .form-control {
                        width: 100%;
                        padding: 12px 15px;
                        border: 2px solid #e1e8ed;
                        border-radius: 8px;
                        font-size: 14px;
                        transition: all 0.3s ease;
                        background: #ffffff;
                    }
                    .form-control:focus {
                        outline: none;
                        border-color: #1976d2;
                        box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.1);
                    }
                    .help-text {
                        display: block;
                        margin-top: 5px;
                        color: #7f8c8d;
                        font-size: 12px;
                        font-style: italic;
                    }
                    .close:hover { opacity: 0.7; }
                    .form-actions {
                        position: sticky;
                        bottom: 0;
                        background: white;
                        z-index: 10;
                    }
                `;
                document.head.appendChild(modalStyles);
            }

            // Setup modal event listeners
            setTimeout(() => {
                console.log('Setting up modal event listeners...');
                const closeBtn = document.getElementById('closeModalBtn');
                const cancelBtn = document.getElementById('cancelModalBtn');
                const cancelBtn2 = document.getElementById('cancelBtn');
                const form = document.getElementById('addBarberForm');
                const submitBtn = document.getElementById('submitBarberBtn');

                console.log('Found elements:', { closeBtn: !!closeBtn, cancelBtn: !!cancelBtn, cancelBtn2: !!cancelBtn2, form: !!form, submitBtn: !!submitBtn });

                if (closeBtn) {
                    closeBtn.addEventListener('click', closeAddBarberModal);
                }
                if (cancelBtn) {
                    cancelBtn.addEventListener('click', closeAddBarberModal);
                }
                if (cancelBtn2) {
                    cancelBtn2.addEventListener('click', closeAddBarberModal);
                }
                if (form) {
                    form.addEventListener('submit', function(e) {
                        e.preventDefault();
                        console.log('Form submitted!');
                        submitAddBarber();
                    });
                }
                // Add fallback click handler for submit button
                if (submitBtn) {
                    submitBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        console.log('Submit button clicked!');
                        submitAddBarber();
                    });
                }
            }, 100);
        }
        
        function closeAddBarberModal() {
            const modal = document.getElementById('addBarberModal');
            if (modal) {
                modal.remove();
            }
        }
        
        async function submitAddBarber() {
            const form = document.getElementById('addBarberForm');
            const formData = new FormData(form);
            
            // Debug: Log form data
            console.log('Form data being submitted:');
            for (let [key, value] of formData.entries()) {
                console.log(`${key}: ${value}`);
            }
            
            // Enhanced validation
            const name = formData.get('name')?.trim();
            const phone = formData.get('phone')?.trim();
            const badge = formData.get('identity_badge_number')?.trim();
            const email = formData.get('email')?.trim();
                            const photoFile = formData.get('profile_photo');
            
            // Validation checks
            if (!name || name.length < 2) {
                alert('Please enter a valid name (at least 2 characters)');
                return;
            }
            
            if (!phone || !/^\+254\d{9}$/.test(phone)) {
                alert('Please enter a valid Kenyan phone number (+254XXXXXXXXX)');
                return;
            }
            
            if (!badge || badge.length < 3) {
                alert('Please enter a valid identity badge number (at least 3 characters)');
                return;
            }
            
            if (email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                alert('Please enter a valid email address');
                return;
            }
            
            if (!photoFile || photoFile.size === 0) {
                alert('Please select a profile photo. This is required.');
                return;
            }
            
            // File size validation (5MB limit)
            if (photoFile.size > 5 * 1024 * 1024) {
                alert('Profile photo must be less than 5MB');
                return;
            }
            
            // File type validation
            const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif'];
            if (!allowedTypes.includes(photoFile.type)) {
                alert('Please select a valid image file (JPG, PNG, or GIF)');
                return;
            }
            
            // Show loading state
            const submitBtn = document.getElementById('submitBarberBtn');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = '⏳ Adding...';
            submitBtn.disabled = true;
            
            try {
                console.log('Sending request to /api/barbers...');
                const response = await fetch('/api/barbers', {
                    method: 'POST',
                    body: formData // Send as FormData for file upload
                });
                
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                console.log('Response data:', result);
                
                if (result.success) {
                    alert('✅ Barber added successfully!');
                    closeAddBarberModal();
                    loadBarbers(); // Refresh the table
                } else {
                    throw new Error(result.message || 'Failed to add barber');
                }
            } catch (error) {
                console.error('Error adding barber:', error);
                alert(`❌ Error adding barber: ${error.message || 'Please try again.'}`);
            } finally {
                // Restore button state
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        }

        function showBlockBarberModal(barberId) {
            // Create and show the enhanced blocking modal
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.cssText = 'display: block; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); backdrop-filter: blur(5px);';
            
            modal.innerHTML = `
                <div class="modal-content" style="background-color: white; margin: 5% auto; padding: 20px; border-radius: 10px; width: 90%; max-width: 500px; max-height: 90vh; box-shadow: 0 4px 20px rgba(0,0,0,0.3); overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="margin: 0; color: #333;">Block Barber</h2>
                        <button onclick="this.closest('.modal').remove()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
                    </div>
                    
                    <form id="blockBarberForm">
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">Block Category:</label>
                            <select id="blockCategory" name="blockCategory" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px;">
                                <option value="Day Off / Emergency">Day Off / Emergency</option>
                                <option value="Policy Violation">Policy Violation</option>
                                <option value="Safety Concern">Safety Concern</option>
                                <option value="Performance Issue">Performance Issue</option>
                                <option value="Customer Complaint">Customer Complaint</option>
                                <option value="Professional Conduct">Professional Conduct</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">Severity Level:</label>
                            <select id="blockSeverity" name="blockSeverity" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px;">
                                <option value="day-off">Day Off / Emergency</option>
                                <option value="warning">Warning</option>
                                <option value="suspension">Suspension</option>
                                <option value="permanent">Permanent Ban</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">Block Type:</label>
                            <select id="blockType" name="blockType" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px;">
                                <option value="permanent">Permanent Block</option>
                                <option value="temporary">Temporary Block</option>
                            </select>
                        </div>
                        
                        <div id="durationField" style="margin-bottom: 15px; display: none;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">Block Duration:</label>
                            <div style="display: flex; gap: 10px;">
                                <input type="number" id="blockDuration" name="blockDuration" min="1" value="1" style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px;">
                                <select id="durationUnit" name="durationUnit" style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px;">
                                    <option value="1">Hours</option>
                                    <option value="24">Days</option>
                                    <option value="168">Weeks</option>
                                </select>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">Block Reason:</label>
                            <textarea id="blockReason" name="blockReason" rows="3" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; resize: vertical;" placeholder="Enter the reason for blocking this barber..." required></textarea>
                        </div>
                        
                        <div style="display: flex; gap: 10px; justify-content: flex-end;">
                            <button type="button" id="cancelBlockBtn" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px;">Cancel</button>
                            <button type="submit" style="padding: 10px 20px; background: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; font-weight: bold;">Block Barber</button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Initialize the duration field visibility
            toggleDurationField();
            
            // Handle block type change
            document.getElementById('blockType').addEventListener('change', function() {
                toggleDurationField();
            });
            
            // Handle severity level changes
            document.getElementById('blockSeverity').addEventListener('change', function() {
                const severity = this.value;
                const blockTypeSelect = document.getElementById('blockType');
                const durationField = document.getElementById('durationField');
                
                console.log('Severity changed to:', severity);
                
                if (severity === 'day-off') {
                    // Auto-set to temporary block for day off/emergency
                    blockTypeSelect.value = 'temporary';
                    blockTypeSelect.disabled = true;
                    durationField.style.display = 'block';
                    // Set default duration to 24 hours (1 day)
                    document.getElementById('blockDuration').value = '1';
                    document.getElementById('durationUnit').value = '24';
                    console.log('Day off logic applied: temporary block, 1 day duration');
                } else {
                    // Re-enable block type selection for other severities
                    blockTypeSelect.disabled = false;
                    toggleDurationField();
                    console.log('Normal severity logic applied');
                }
            });
            
            // Also handle category changes for "Day Off / Emergency"
            document.getElementById('blockCategory').addEventListener('change', function() {
                const category = this.value;
                const severitySelect = document.getElementById('blockSeverity');
                const blockTypeSelect = document.getElementById('blockType');
                const durationField = document.getElementById('durationField');
                
                console.log('Category changed to:', category);
                
                if (category === 'Day Off / Emergency') {
                    // Auto-set severity to day-off and apply temporary logic
                    severitySelect.value = 'day-off';
                    blockTypeSelect.value = 'temporary';
                    blockTypeSelect.disabled = true;
                    durationField.style.display = 'block';
                    document.getElementById('blockDuration').value = '1';
                    document.getElementById('durationUnit').value = '24';
                    console.log('Day Off category logic applied');
                }
            });
            
            // Handle category changes for better logic
            document.getElementById('blockCategory').addEventListener('change', function() {
                const category = this.value;
                const severity = document.getElementById('blockSeverity').value;
                
                // If category suggests temporary nature, auto-adjust severity
                if (category === 'Other' && severity === 'day-off') {
                    // Keep the day-off logic
                    const blockTypeSelect = document.getElementById('blockType');
                    const durationField = document.getElementById('durationField');
                    blockTypeSelect.value = 'temporary';
                    blockTypeSelect.disabled = true;
                    durationField.style.display = 'block';
                    document.getElementById('blockDuration').value = '1';
                    document.getElementById('durationUnit').value = '24';
                }
            });
            
            // Set initial state based on current severity and category
            const initialSeverity = document.getElementById('blockSeverity').value;
            const initialCategory = document.getElementById('blockCategory').value;
            
            console.log('Initial modal state:', { initialSeverity, initialCategory });
            
            if (initialSeverity === 'day-off' || initialCategory === 'Day Off / Emergency') {
                const blockTypeSelect = document.getElementById('blockType');
                const durationField = document.getElementById('durationField');
                const severitySelect = document.getElementById('blockSeverity');
                
                // Ensure both are set correctly
                severitySelect.value = 'day-off';
                blockTypeSelect.value = 'temporary';
                blockTypeSelect.disabled = true;
                durationField.style.display = 'block';
                document.getElementById('blockDuration').value = '1';
                document.getElementById('durationUnit').value = '24';
                
                console.log('Initial day-off logic applied');
            }
            
            // Handle cancel button
            document.getElementById('cancelBlockBtn').addEventListener('click', function() {
                modal.remove();
            });
            
            // Handle form submission
            document.getElementById('blockBarberForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Get values directly from the form elements to ensure we capture the current state
                const blockType = document.getElementById('blockType').value;
                const blockReason = document.getElementById('blockReason').value;
                const blockDuration = document.getElementById('blockDuration').value;
                const durationUnit = document.getElementById('durationUnit').value;
                const blockCategory = document.getElementById('blockCategory').value;
                const blockSeverity = document.getElementById('blockSeverity').value;
                
                console.log('Form submission values:', {
                    blockType, blockReason, blockDuration, durationUnit, blockCategory, blockSeverity
                });
                
                if (!blockReason.trim()) {
                    alert('Please enter a block reason');
                    return;
                }
                
                if (blockType === 'temporary' && (!blockDuration || blockDuration < 1)) {
                    alert('Please enter a valid duration for temporary blocks');
                    return;
                }
                
                // Calculate duration in hours
                let durationHours = null;
                if (blockType === 'temporary') {
                    durationHours = parseInt(blockDuration) * parseInt(durationUnit);
                    console.log('Duration calculated:', durationHours, 'hours');
                }
                
                // Close modal and block barber with all the form data
                modal.remove();
                blockBarber(barberId, blockReason.trim(), blockType, durationHours, blockCategory, blockSeverity);
            });
        }
        
        function toggleDurationField() {
            console.log('toggleDurationField called');
            const blockType = document.getElementById('blockType').value;
            const durationField = document.getElementById('durationField');
            console.log('Block type:', blockType);
            console.log('Duration field found:', durationField);
            
            if (durationField) {
                const shouldShow = blockType === 'temporary';
                durationField.style.display = shouldShow ? 'block' : 'none';
                console.log('Duration field display set to:', shouldShow ? 'block' : 'none');
            } else {
                console.error('Duration field not found!');
            }
        }

        async function blockBarber(barberId, reason, blockType = 'permanent', durationHours = null, blockCategory = null, blockSeverity = null) {
            if (!barberId || !reason) {
                alert('Invalid barber ID or reason provided');
                return;
            }
            
            let row = null;
            let originalContent = null;
            
            try {
                // Show loading state for this specific row - improved selector
                const button = document.querySelector(`[data-barber-id="${barberId}"]`);
                if (!button) {
                    throw new Error('Barber button not found');
                }
                row = button.closest('tr');
                if (!row) {
                    throw new Error('Barber row not found');
                }
                
                originalContent = row.innerHTML;
                row.innerHTML = '<td colspan="12" style="text-align: center; padding: 1rem; color: #666;">Processing...</td>';
                
                console.log('Blocking barber:', barberId, 'with reason:', reason, 'type:', blockType, 'duration:', durationHours);
                
                // Use the parameters passed to the function
                console.log('Function parameters:', { 
                    barberId, reason, blockType, durationHours, blockCategory, blockSeverity 
                });
                
                // Set default values if not provided
                const finalBlockCategory = blockCategory || 'Policy Violation';
                const finalBlockSeverity = blockSeverity || 'suspension';
                const finalBlockType = blockType || 'permanent';
                
                console.log('Final values to send:', { 
                    finalBlockCategory, 
                    finalBlockSeverity, 
                    finalBlockType, 
                    durationHours 
                });
                
                const requestBody = {
                    block_reason: reason,
                    blocked_by: 1, // Admin ID (you can implement proper admin authentication later)
                    block_type: finalBlockType,
                    block_category: finalBlockCategory,
                    block_severity: finalBlockSeverity
                };
                
                if (finalBlockType === 'temporary' && durationHours) {
                    requestBody.block_duration_hours = durationHours;
                    console.log('Duration set to:', durationHours, 'hours');
                }
                
                const response = await fetch(`/api/barbers/${barberId}/block`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                console.log('Block response status:', response.status);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Block response error:', errorText);
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('Block response data:', data);
                
                if (data.success) {
                    const message = blockType === 'temporary' 
                        ? `✅ Barber temporarily blocked for ${durationHours} hours!` 
                        : '✅ Barber permanently blocked!';
                    alert(message);
                    // Refresh the table immediately
                    await loadBarbers();
                } else {
                    throw new Error(data.message || 'Failed to block barber');
                }
            } catch (error) {
                console.error('Error blocking barber:', error);
                alert(`❌ Error blocking barber: ${error.message}`);
                // Restore original content if error
                if (row && originalContent) {
                    row.innerHTML = originalContent;
                }
            }
        }

        async function unblockBarber(barberId) {
            if (!barberId) {
                alert('Invalid barber ID provided');
                return;
            }
            
            let row = null;
            let originalContent = null;
            
            try {
                // Show loading state for this specific row - improved selector
                const button = document.querySelector(`[data-barber-id="${barberId}"]`);
                if (!button) {
                    throw new Error('Barber button not found');
                }
                row = button.closest('tr');
                if (!row) {
                    throw new Error('Barber row not found');
                }
                
                originalContent = row.innerHTML;
                row.innerHTML = '<td colspan="7" style="text-align: center; padding: 1rem; color: #666;">Processing...</td>';
                
                console.log('Unblocking barber:', barberId);
                
                const response = await fetch(`/api/barbers/${barberId}/unblock`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                console.log('Unblock response status:', response.status);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Unblock response error:', errorText);
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('Unblock response data:', data);
                
                if (data.success) {
                    alert('✅ Barber unblocked successfully!');
                    // Refresh the table immediately
                    await loadBarbers();
                } else {
                    throw new Error(data.message || 'Failed to unblock barber');
                }
            } catch (error) {
                console.error('Error unblocking barber:', error);
                alert(`❌ Error unblocking barber: ${error.message}`);
                // Restore original content if error
                if (row && originalContent) {
                    row.innerHTML = originalContent;
                }
            }
        }

        function editBarber(id) {
            console.log('Edit barber called for ID:', id);
            showEditBarberModal(id);
        }

        function showEditBarberModal(barberId) {
            console.log('showEditBarberModal called for ID:', barberId);
            
            // Show loading state
            const loadingBarber = {
                id: barberId,
                name: 'Loading...',
                phone: 'Loading...',
                email: 'Loading...',
                identity_badge_number: 'Loading...',
                current_location: 'Loading...',
                is_active: 1,
                total_services: 0,
                total_earnings: 0
            };
            createEditModal(loadingBarber);
            
            // Fetch the barber data
            fetch(`/api/barbers/${barberId}`)
                .then(response => {
                    console.log('API Response status:', response.status);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('API Response data:', data);
                    if (data.success && data.barber) {
                        const barber = data.barber;
                        // Update the modal with real data
                        updateEditModalWithData(barber);
                    } else {
                        throw new Error(data.message || 'Failed to load barber data');
                    }
                })
                .catch(error => {
                    console.error('Error fetching barber data:', error);
                    alert('❌ Error loading barber data: ' + error.message);
                    // Keep the modal open but show error state
                    updateEditModalWithData({
                        id: barberId,
                        name: 'Error loading data',
                        phone: 'Error loading data',
                        email: 'Error loading data',
                        identity_badge_number: 'Error loading data',
                        current_location: 'Error loading data',
                        is_active: 1,
                        total_services: 0,
                        total_earnings: 0
                    });
                });
        }

        function updateEditModalWithData(barber) {
            // Update the form fields with the barber data
            const nameField = document.getElementById('editBarberName');
            const phoneField = document.getElementById('editBarberPhone');
            const emailField = document.getElementById('editBarberEmail');
            const badgeField = document.getElementById('editBarberBadge');
            const locationField = document.getElementById('editBarberLocation');
            const statusField = document.getElementById('editBarberStatus');
            const servicesField = document.getElementById('editBarberServices');
            const earningsField = document.getElementById('editBarberEarnings');
            
            if (nameField) nameField.value = barber.name || '';
            if (phoneField) phoneField.value = barber.phone || '';
            if (emailField) emailField.value = barber.email || '';
            if (badgeField) badgeField.value = barber.identity_badge_number || '';
            if (locationField) locationField.value = barber.current_location || '';
            if (statusField) statusField.value = barber.is_active ? '1' : '0';
            if (servicesField) servicesField.value = barber.total_services || 0;
            if (earningsField) earningsField.value = barber.total_earnings || 0;
        }

        function createEditModal(barber) {
            // Remove any existing edit modal first
            const existingModal = document.getElementById('editBarberModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Create modal HTML with Adminator-style design
            const modalHTML = `
                <div id="editBarberModal" class="modal" style="display: block; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); backdrop-filter: blur(5px);">
                    <div class="modal-content" style="max-width: 700px; max-height: 90vh; margin: 2% auto; background: white; border-radius: 15px; box-shadow: 0 20px 40px rgba(0,0,0,0.3); animation: modalSlideIn 0.3s ease-out; overflow: hidden; position: relative;">
                        <div class="modal-header" style="background: #1976d2; color: white; padding: 20px 25px; border-radius: 15px 15px 0 0; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0;">
                            <h3 style="margin: 0; font-size: 20px; font-weight: 600;">Edit Barber</h3>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <button id="cancelEditModalBtn" style="padding: 8px 16px; background: #e74c3c; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 12px; font-weight: 500;">❌ Cancel</button>
                                <span class="close" id="closeEditModalBtn" style="color: white; font-size: 24px; cursor: pointer; margin-left: 10px;">&times;</span>
                            </div>
                        </div>
                        <div class="modal-body" style="padding: 30px; max-height: calc(90vh - 80px); overflow-y: auto;">
                            <form id="editBarberForm" enctype="multipart/form-data">
                                <input type="hidden" id="editBarberId" name="id" value="${barber.id}">
                                
                                <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                                    <div class="control-group">
                                        <label class="control-label" for="editBarberName">Full Name *</label>
                                        <div class="controls">
                                            <input type="text" id="editBarberName" name="name" value="${escapeHtml(barber.name || '')}" placeholder="Enter barber's full name" class="form-control" required>
                                        </div>
                                    </div>
                                    
                                    <div class="control-group">
                                        <label class="control-label" for="editBarberPhone">Mobile Number *</label>
                                        <div class="controls">
                                            <input type="tel" id="editBarberPhone" name="phone" value="${escapeHtml(barber.phone || '')}" placeholder="+254XXXXXXXXX" class="form-control" required>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                                    <div class="control-group">
                                        <label class="control-label" for="editBarberEmail">Email Address</label>
                                        <div class="controls">
                                            <input type="email" id="editBarberEmail" name="email" value="${escapeHtml(barber.email || '')}" placeholder="barber@jazzman.com" class="form-control">
                                        </div>
                                    </div>
                                    
                                    <div class="control-group">
                                        <label class="control-label" for="editBarberBadge">Identity Badge Number *</label>
                                        <div class="controls">
                                            <input type="text" id="editBarberBadge" name="identity_badge_number" value="${escapeHtml(barber.identity_badge_number || '')}" placeholder="e.g., JM001, JB001" class="form-control" required>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="control-group" style="margin-bottom: 20px;">
                                    <label class="control-label" for="editBarberLocation">Current Location</label>
                                    <div class="controls">
                                        <input type="text" id="editBarberLocation" name="current_location" value="${escapeHtml(barber.current_location || '')}" placeholder="e.g., Westlands, Nairobi" class="form-control">
                                    </div>
                                </div>
                                
                                <div class="control-group" style="margin-bottom: 20px;">
                                    <label class="control-label" for="editBarberPhoto">Profile Photo</label>
                                    <div class="controls">
                                        <input type="file" id="editBarberPhoto" name="profile_photo" accept="image/*" class="form-control">
                                        <small class="help-text">Leave empty to keep current photo. Max size: 5MB. Supported formats: JPG, PNG, GIF</small>
                                        ${barber.profile_photo ? `<div style="margin-top: 10px;"><img src="${escapeHtml(barber.profile_photo)}" alt="Current photo" style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 2px solid #ddd;"></div>` : ''}
                                    </div>
                                </div>
                                
                                <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 30px;">
                                    <div class="control-group">
                                        <label class="control-label" for="editBarberStatus">Status</label>
                                        <div class="controls">
                                            <select id="editBarberStatus" name="is_active" class="form-control">
                                                <option value="1" ${barber.is_active ? 'selected' : ''}>🟢 Active</option>
                                                <option value="0" ${!barber.is_active ? 'selected' : ''}>🔴 Inactive</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="control-group">
                                        <label class="control-label" for="editBarberServices">Total Service Count</label>
                                        <div class="controls">
                                            <input type="number" id="editBarberServices" name="total_services" min="0" value="${barber.total_services || 0}" placeholder="0" class="form-control">
                                        </div>
                                    </div>
                                    
                                    <div class="control-group">
                                        <label class="control-label" for="editBarberEarnings">Total Earnings (KES)</label>
                                        <div class="controls">
                                            <input type="number" id="editBarberEarnings" name="total_earnings" min="0" step="0.01" value="${barber.total_earnings || 0}" placeholder="0.00" class="form-control">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="form-actions" style="display: flex; gap: 15px; justify-content: flex-end; border-top: 1px solid #eee; padding-top: 20px; margin-top: 20px;">
                                    <button type="button" id="cancelEditBtn" style="padding: 12px 24px; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 500;">Cancel</button>
                                    <button type="submit" id="submitEditBarberBtn" style="padding: 12px 30px; background: #1976d2; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 16px;">💾 Update Barber</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;
            
            // Add modal to body
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            console.log('Edit modal added to DOM');
            
            // Setup modal event listeners
            setTimeout(() => {
                console.log('Setting up edit modal event listeners...');
                const closeBtn = document.getElementById('closeEditModalBtn');
                const cancelBtn = document.getElementById('cancelEditModalBtn');
                const cancelBtn2 = document.getElementById('cancelEditBtn');
                const form = document.getElementById('editBarberForm');
                const submitBtn = document.getElementById('submitEditBarberBtn');

                console.log('Found edit elements:', { closeBtn: !!closeBtn, cancelBtn: !!cancelBtn, cancelBtn2: !!cancelBtn2, form: !!form, submitBtn: !!submitBtn });

                if (closeBtn) {
                    closeBtn.addEventListener('click', closeEditBarberModal);
                }
                if (cancelBtn) {
                    cancelBtn.addEventListener('click', closeEditBarberModal);
                }
                if (cancelBtn2) {
                    cancelBtn2.addEventListener('click', closeEditBarberModal);
                }
                if (form) {
                    form.addEventListener('submit', function(e) {
                        e.preventDefault();
                        console.log('Edit form submitted!');
                        submitEditBarber();
                    });
                }
                if (submitBtn) {
                    submitBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        console.log('Edit submit button clicked!');
                        submitEditBarber();
                    });
                }
            }, 100);
        }

        function closeEditBarberModal() {
            const modal = document.getElementById('editBarberModal');
            if (modal) {
                modal.remove();
            }
        }

        async function submitEditBarber() {
            const form = document.getElementById('editBarberForm');
            const formData = new FormData(form);
            
            // Enhanced validation
            const name = formData.get('name')?.trim();
            const phone = formData.get('phone')?.trim();
            const badge = formData.get('identity_badge_number')?.trim();
            const email = formData.get('email')?.trim();
            const location = formData.get('current_location')?.trim();
            const status = formData.get('is_active');
            const services = formData.get('total_services') || 0;
            const earnings = formData.get('total_earnings') || 0;
            const barberId = formData.get('id');
            
            // Validation checks
            if (!name || name.length < 2) {
                alert('Please enter a valid name (at least 2 characters)');
                return;
            }
            
            if (!phone || !/^\+254\d{9}$/.test(phone)) {
                alert('Please enter a valid Kenyan phone number (+254XXXXXXXXX)');
                return;
            }
            
            if (!badge || badge.length < 3) {
                alert('Please enter a valid identity badge number (at least 3 characters)');
                return;
            }
            
            if (email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                alert('Please enter a valid email address');
                return;
            }
            
            // Show loading state
            const submitBtn = document.getElementById('submitEditBarberBtn');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = '⏳ Updating...';
            submitBtn.disabled = true;
            
            try {
                console.log('Sending edit request to /api/barbers/' + barberId);
                
                // Prepare JSON data for the backend
                const updateData = {
                    name: name,
                    phone: phone.replace('+', ''), // Remove + prefix for backend
                    email: email,
                    identity_badge_number: badge,
                    current_location: location,
                    is_active: status === '1' ? 1 : 0,
                    total_services: parseInt(services) || 0,
                    total_earnings: parseFloat(earnings) || 0
                };
                
                console.log('Update data:', updateData);
                
                // Create FormData for multipart upload (backend expects this)
                const formData = new FormData();
                formData.append('name', updateData.name);
                formData.append('phone', updateData.phone);
                formData.append('email', updateData.email);
                formData.append('identity_badge_number', updateData.identity_badge_number);
                formData.append('current_location', updateData.current_location);
                formData.append('is_active', updateData.is_active);
                formData.append('total_services', updateData.total_services);
                formData.append('total_earnings', updateData.total_earnings);
                
                // Add file if selected
                const fileInput = document.getElementById('editBarberPhoto');
                if (fileInput && fileInput.files[0]) {
                    formData.append('profile_photo', fileInput.files[0]);
                }
                
                const response = await fetch(`/api/barbers/${barberId}`, {
                    method: 'PUT',
                    body: formData
                });
                
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                console.log('Response data:', result);
                
                if (result.success) {
                    alert('✅ Barber updated successfully!');
                    closeEditBarberModal();
                    loadBarbers(); // Refresh the table
                } else {
                    throw new Error(result.message || 'Failed to update barber');
                }
            } catch (error) {
                console.error('Error updating barber:', error);
                alert(`❌ Error updating barber: ${error.message || 'Please try again.'}`);
            } finally {
                // Restore button state
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        }

        async function deleteBarber(id) {
            if (confirm('⚠️ Are you sure you want to delete this barber? This action cannot be undone.')) {
                try {
                    console.log('Deleting barber:', id);
                    
                    const response = await fetch(`/api/barbers/${id}`, {
                        method: 'DELETE'
                    });
                    
                    console.log('Delete response status:', response.status);
                    
                    if (response.ok) {
                        const result = await response.json();
                        console.log('Delete response:', result);
                        
                        if (result.success) {
                            alert('✅ Barber deleted successfully!');
                            await loadBarbers();
                        } else {
                            alert('❌ Failed to delete barber: ' + (result.message || 'Unknown error'));
                        }
                    } else {
                        const errorText = await response.text();
                        console.error('Delete error response:', errorText);
                        alert('❌ Failed to delete barber. Please try again.');
                    }
                } catch (error) {
                    console.error('Error deleting barber:', error);
                    alert('❌ Error deleting barber. Please check console for details.');
                }
            }
        }
        
        function updateBarberPhoto(barberId) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                if (file.size > 5 * 1024 * 1024) {
                    alert('File size must be less than 5MB');
                    return;
                }
                
                const formData = new FormData();
                formData.append('profile_photo', file);
                
                try {
                    const response = await fetch(`/api/barbers/${barberId}/photo`, {
                        method: 'POST',
                        body: formData
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        alert('Barber photo updated successfully!');
                        loadBarbers(); // Refresh the table
                    } else {
                        alert('Failed to update photo: ' + result.message);
                    }
                } catch (error) {
                    console.error('Error updating barber photo:', error);
                    alert('Error updating photo. Please try again.');
                }
            };
            input.click();
        }
        
        // Close modal when clicking outside
        window.onclick = function(event) {
            const addBarberModal = document.getElementById('addBarberModal');
            if (addBarberModal && event.target === addBarberModal) {
                closeAddBarberModal();
            }
        }

        // ===== WORKING HOURS MANAGEMENT =====
        
        // Load working hours data
        async function loadWorkingHours() {
            try {
                console.log('🔄 Loading working hours summary...');
                const response = await fetch('/api/working-hours/summary');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('📥 Summary data received:', data);
                
                if (data.success) {
                    updateWorkingHoursDisplay(data.workingHours);
                    updateWorkingHoursTable();
                } else {
                    throw new Error(data.message || 'Failed to load working hours');
                }
            } catch (error) {
                console.error('Error loading working hours:', error);
                updateWorkingHoursDisplay({
                    today: { day: 'Unknown', isOpen: false, hours: 'Error loading' },
                    weekly: [],
                    nextOpen: null
                });
            }
        }

        // Update working hours display cards
        function updateWorkingHoursDisplay(workingHours) {
            // Today's status
            const todayStatus = document.getElementById('todayStatus');
            const todayHours = document.getElementById('todayHours');
            
            if (workingHours.today) {
                todayStatus.textContent = workingHours.today.isOpen ? '🟢 Open' : '🔴 Closed';
                todayHours.textContent = workingHours.today.hours;
                todayStatus.className = workingHours.today.isOpen ? 'stat-value success' : 'stat-value danger';
            }

            // Next open time
            const nextOpen = document.getElementById('nextOpen');
            const nextOpenDetails = document.getElementById('nextOpenDetails');
            
            if (workingHours.nextOpen) {
                const nextDate = new Date(workingHours.nextOpen.date);
                nextOpen.textContent = nextDate.toLocaleDateString();
                nextOpenDetails.textContent = `${workingHours.nextOpen.day} at ${workingHours.nextOpen.time}`;
            } else {
                nextOpen.textContent = 'No upcoming';
                nextOpenDetails.textContent = 'No open days found';
            }

            // Weekly hours summary
            const weeklyHours = document.getElementById('weeklyHours');
            const openDays = workingHours.weekly.filter(day => day.isOpen).length;
            weeklyHours.textContent = `${openDays}/7 days`;
        }

        // Load and display working hours table
        async function updateWorkingHoursTable() {
            try {
                console.log('🔄 Loading working hours table data...');
                const response = await fetch('/api/working-hours');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('📥 Table data received:', data);
                
                if (data.success) {
                    displayWorkingHoursTable(data.workingHours);
                } else {
                    throw new Error(data.message || 'Failed to load working hours');
                }
            } catch (error) {
                console.error('Error loading working hours table:', error);
                const tbody = document.getElementById('workingHoursBody');
                tbody.innerHTML = `<tr><td colspan="7" style="text-align: center; padding: 2rem; color: #dc3545;">Error loading working hours: ${error.message}</td></tr>`;
            }
        }

        // Display working hours in table
        function displayWorkingHoursTable(workingHours) {
            console.log('🎨 Displaying working hours table with data:', workingHours);
            const tbody = document.getElementById('workingHoursBody');
            tbody.innerHTML = '';
            
                        workingHours.forEach(day => {
                console.log(`📅 Processing day: ${day.day_name} (${day.day_of_week}) - Open: ${day.is_open}, Times: ${day.open_time}-${day.close_time}`);
                const row = tbody.insertRow();
                row.setAttribute('data-day', day.day_of_week);
                row.innerHTML = `
                    <td><strong>${escapeHtml(day.day_name)}</strong></td>
                    <td>
                        <label class="switch">
                            <input type="checkbox" class="status-toggle" data-day="${day.day_of_week}" ${day.is_open ? 'checked' : ''}>
                            <span class="slider round"></span>
                        </label>
                        <span class="status-text" id="status-${day.day_of_week}">${day.is_open ? 'Open' : 'Closed'}</span>
                    </td>
                    <td>
                        <input type="time" class="time-input" data-day="${day.day_of_week}" data-field="open_time" value="${day.open_time}" 
                               ${!day.is_open ? 'disabled' : ''}>
                    </td>
                    <td>
                        <input type="time" class="time-input" data-day="${day.day_of_week}" data-field="close_time" value="${day.close_time}" 
                               ${!day.is_open ? 'disabled' : ''}>
                    </td>
                    <td>
                        <input type="text" class="notes-input" data-day="${day.day_of_week}" data-field="notes" value="${escapeHtml(day.notes || '')}" 
                               placeholder="Optional notes" ${!day.is_open ? 'disabled' : ''}>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-secondary reset-btn" data-day="${day.day_of_week}">
                            <i>🔄</i> Reset
                        </button>
                    </td>
                `;
                
                // Enable/disable time inputs based on initial status
                const timeInputs = row.querySelectorAll('.time-input');
                timeInputs.forEach(input => {
                    input.disabled = !day.is_open;
                });
            });
            
            // Set up event listeners after table is populated
            setupWorkingHoursListeners();
        }

        // Toggle day open/closed status
        async function toggleDayStatus(dayOfWeek, isOpen) {
            try {
                console.log(`🔄 Toggling day ${dayOfWeek} to ${isOpen ? 'open' : 'closed'}`);
                
                // Get current working hours for this day
                const response = await fetch('/api/working-hours');
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error('Failed to get current working hours');
                }
                
                const day = data.workingHours.find(d => d.day_of_week === dayOfWeek);
                if (!day) {
                    throw new Error('Day not found');
                }

                console.log(`📝 Current day data:`, day);

                // Update the day status
                const updateData = {
                    is_open: isOpen,
                    open_time: day.open_time,
                    close_time: day.close_time,
                    notes: day.notes,
                    break_start: '',
                    break_end: ''
                };

                console.log(`📤 Sending update data:`, updateData);

                const updateResponse = await fetch(`/api/working-hours/${dayOfWeek}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updateData)
                });

                console.log(`📡 Response status:`, updateResponse.status);
                console.log(`📡 Response headers:`, updateResponse.headers);

                if (!updateResponse.ok) {
                    const errorText = await updateResponse.text();
                    throw new Error(`HTTP ${updateResponse.status}: ${errorText}`);
                }

                const result = await updateResponse.json();
                console.log(`✅ Update response:`, result);

                // Update the status text immediately
                const statusElement = document.getElementById(`status-${dayOfWeek}`);
                if (statusElement) {
                    statusElement.textContent = isOpen ? 'Open' : 'Closed';
                    console.log(`✅ Status text updated to: ${statusElement.textContent}`);
                } else {
                    console.warn(`⚠️ Status element not found for day ${dayOfWeek}`);
                }

                // Enable/disable time inputs based on status
                const row = document.querySelector(`#workingHoursBody tr[data-day="${dayOfWeek}"]`);
                if (row) {
                    const timeInputs = row.querySelectorAll('.time-input');
                    timeInputs.forEach(input => {
                        input.disabled = !isOpen;
                        console.log(`✅ Time input ${input.type} ${isOpen ? 'enabled' : 'disabled'}`);
                    });
                } else {
                    console.warn(`⚠️ Row not found for day ${dayOfWeek}`);
                }

                // Show success message
                const statusText = isOpen ? 'opened' : 'closed';
                console.log(`🎉 ${day.day_name} ${statusText} successfully`);
                
                // Refresh the working hours display to ensure consistency
                setTimeout(() => {
                    loadWorkingHours();
                }, 500);
                
            } catch (error) {
                console.error('❌ Error toggling day status:', error);
                alert(`❌ Error updating ${day?.day_name || 'this day'}: ${error.message}`);
                // Revert the checkbox by refreshing the table
                await updateWorkingHoursTable();
            }
        }

        // Update specific working hours field
        async function updateWorkingHours(dayOfWeek, field, value) {
            try {
                // Get current working hours for this day
                const response = await fetch('/api/working-hours');
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error('Failed to get current working hours');
                }
                
                const day = data.workingHours.find(d => d.day_of_week === dayOfWeek);
                if (!day) {
                    throw new Error('Day not found');
                }

                // Update the specific field
                const updateData = {
                    is_open: day.is_open,
                    open_time: day.open_time,
                    close_time: day.close_time,
                    notes: day.notes,
                    break_start: '',
                    break_end: ''
                };
                
                updateData[field] = value;

                const updateResponse = await fetch(`/api/working-hours/${dayOfWeek}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updateData)
                });

                if (!updateResponse.ok) {
                    throw new Error('Failed to update working hours');
                }

                console.log(`✅ Updated ${field} for ${day.day_name}`);
                
            } catch (error) {
                console.error('Error updating working hours:', error);
                alert(`❌ Error updating ${field}: ${error.message}`);
            }
        }

        // Reset day to default values
        async function resetDayToDefault() {
            if (confirm('⚠️ Reset this day to default working hours?')) {
                try {
                    const response = await fetch('/api/working-hours/reset', {
                        method: 'POST'
                    });
                    
                    if (response.ok) {
                        alert('✅ Working hours reset to defaults. Please run the migration script to apply changes.');
                        await loadWorkingHours();
                    } else {
                        throw new Error('Failed to reset working hours');
                    }
                } catch (error) {
                    console.error('Error resetting working hours:', error);
                    alert(`❌ Error resetting working hours: ${error.message}`);
                }
            }
        }

        // Test time validation
        async function testTimeValidation() {
            const testTime = prompt('Enter a test date and time (YYYY-MM-DD HH:MM):', 
                new Date().toISOString().slice(0, 16).replace('T', ' '));
            
            if (!testTime) return;
            
            try {
                const response = await fetch('/api/working-hours/check', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ datetime: new Date(testTime).toISOString() })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const result = data.result;
                    if (result.isOpen) {
                        alert(`✅ Time is within working hours!\n\n${result.reason}\nOpen: ${result.currentHours.open}\nClose: ${result.currentHours.close}${result.currentHours.break ? '\nBreak: ' + result.currentHours.break : ''}`);
                    } else {
                        alert(`❌ Time is outside working hours.\n\n${result.reason}${result.nextOpen ? '\n\nNext open: ' + result.nextOpen.day + ' at ' + result.nextOpen.time : ''}`);
                    }
                } else {
                    throw new Error(data.message || 'Failed to check time');
                }
            } catch (error) {
                console.error('Error testing time validation:', error);
                alert(`❌ Error testing time validation: ${error.message}`);
            }
        }

        // Export working hours
        function exportWorkingHours() {
            // This would generate a CSV or PDF export
            alert('📤 Export functionality coming soon!');
        }

        // Setup working hours event listeners
        function setupWorkingHoursListeners() {
            console.log('🔧 Setting up working hours event listeners...');
            
            // Status toggle listeners
            document.querySelectorAll('.status-toggle').forEach(toggle => {
                toggle.addEventListener('change', function() {
                    const dayOfWeek = parseInt(this.getAttribute('data-day'));
                    const isOpen = this.checked;
                    console.log(`🔄 Status toggle changed for day ${dayOfWeek} to ${isOpen ? 'open' : 'closed'}`);
                    toggleDayStatus(dayOfWeek, isOpen);
                });
            });
            
            // Time input listeners
            document.querySelectorAll('.time-input').forEach(input => {
                input.addEventListener('change', function() {
                    const dayOfWeek = parseInt(this.getAttribute('data-day'));
                    const field = this.getAttribute('data-field');
                    const value = this.value;
                    console.log(`🕐 Time input changed for day ${dayOfWeek}, field ${field}: ${value}`);
                    updateWorkingHours(dayOfWeek, field, value);
                });
            });
            
            // Notes input listeners
            document.querySelectorAll('.notes-input').forEach(input => {
                input.addEventListener('change', function() {
                    const dayOfWeek = parseInt(this.getAttribute('data-day'));
                    const field = this.getAttribute('data-field');
                    const value = this.value;
                    console.log(`📝 Notes input changed for day ${dayOfWeek}: ${value}`);
                    updateWorkingHours(dayOfWeek, field, value);
                });
            });
            
            // Reset button listeners
            document.querySelectorAll('.reset-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const dayOfWeek = parseInt(this.getAttribute('data-day'));
                    console.log(`🔄 Reset button clicked for day ${dayOfWeek}`);
                    resetDayToDefault(dayOfWeek);
                });
            });

            // Save all changes button
            const saveBtn = document.getElementById('saveWorkingHoursBtn');
            if (saveBtn) {
                saveBtn.addEventListener('click', async () => {
                    saveBtn.disabled = true;
                    saveBtn.innerHTML = '<i>💾</i> Saving...';
                    
                    try {
                        await loadWorkingHours();
                        alert('✅ All working hours changes saved successfully!');
                    } catch (error) {
                        alert('❌ Error saving changes: ' + error.message);
                    } finally {
                        saveBtn.disabled = false;
                        saveBtn.innerHTML = '<i>💾</i> Save All Changes';
                    }
                });
            }

            // Reset button
            const resetBtn = document.getElementById('resetWorkingHoursBtn');
            if (resetBtn) {
                resetBtn.addEventListener('click', resetDayToDefault);
            }

            // Test button
            const testBtn = document.getElementById('testWorkingHoursBtn');
            if (testBtn) {
                testBtn.addEventListener('click', testTimeValidation);
            }

            // Export button
            const exportBtn = document.getElementById('exportWorkingHoursBtn');
            if (exportBtn) {
                exportBtn.addEventListener('click', exportWorkingHours);
            }
            
            console.log('✅ Working hours event listeners set up successfully');
        }

        // Load working hours when tab is shown
        document.addEventListener('DOMContentLoaded', function() {
            // Add working hours to the initial data loading
            if (typeof loadWorkingHours === 'function') {
                loadWorkingHours();
                setupWorkingHoursListeners();
            }
            
            // Initialize payment and client management
            initializePaymentManagement();
            initializeClientManagement();
        });

        // ========================================
        // PAYMENT MANAGEMENT FUNCTIONS
        // ========================================
        
        let paymentsData = [];
        let clientsData = [];

        async function initializePaymentManagement() {
            console.log('🔧 Initializing payment management...');
            await loadPayments();
            setupPaymentEventListeners();
            
            // Add Payment button event listener
            const addPaymentBtn = document.getElementById('addPaymentBtn');
            if (addPaymentBtn) {
                addPaymentBtn.addEventListener('click', showAddPaymentModal);
                console.log('🔧 Add Payment button event listener added');
            } else {
                console.log('⚠️ Add Payment button not found');
            }
            
            // Test Daily Summary button event listener
            const testDailySummaryBtn = document.getElementById('testDailySummaryBtn');
            if (testDailySummaryBtn) {
                testDailySummaryBtn.addEventListener('click', testDailySummary);
                console.log('🔧 Test Daily Summary button event listener added');
            } else {
                console.log('⚠️ Test Daily Summary button not found');
            }
            
                    // Event delegation for payment table buttons
        document.addEventListener('click', function(e) {
            if (e.target.matches('[data-action]')) {
                const action = e.target.getAttribute('data-action');
                const paymentId = e.target.getAttribute('data-payment-id');
                
                console.log('🔧 Payment button clicked:', action, paymentId);
                
                switch(action) {
                    case 'mark-received':
                        markPaymentReceived(paymentId);
                        break;
                    case 'mark-pending':
                        markPaymentPending(paymentId);
                        break;
                    case 'view-details':
                        viewPaymentDetails(paymentId);
                        break;
                }
            }
            
                    // Event delegation for close modal buttons
        if (e.target.matches('.close-btn')) {
            const modalId = e.target.closest('.modal-overlay').id;
            console.log('🔧 Close modal button clicked:', modalId);
            closeModal(modalId);
        }
        
        // Event delegation for modal cancel buttons
        if (e.target.matches('[data-modal-id]')) {
            const modalId = e.target.getAttribute('data-modal-id');
            console.log('🔧 Modal cancel button clicked:', modalId);
            closeModal(modalId);
        }
        });
        
        // Event delegation for booking table buttons
        document.addEventListener('click', function(e) {
            // Check if the clicked element or its parent has data-action
            let target = e.target;
            let action = null;
            let bookingId = null;
            
            // Look for data-action in the clicked element or its parents
            while (target && target !== document) {
                if (target.hasAttribute('data-action')) {
                    action = target.getAttribute('data-action');
                    bookingId = target.getAttribute('data-booking-id');
                    break;
                }
                target = target.parentElement;
            }
            
            if (action && bookingId) {
                console.log('🔧 Booking button clicked:', action, bookingId);
                
                switch(action) {
                    case 'view-booking':
                        viewBookingDetails(bookingId);
                        break;
                    case 'reschedule-booking':
                        rescheduleBooking(bookingId);
                        break;
                    case 'record-payment':
                        recordPayment(bookingId);
                        break;
                    case 'cancel-booking':
                        cancelBooking(bookingId);
                        break;
                    case 'submit-payment':
                        submitPayment(bookingId);
                        break;
                    case 'submit-reschedule':
                        submitReschedule(bookingId);
                        break;
                }
            }
        });
        }

        async function loadPayments() {
            try {
                const response = await fetch('/api/payment-management');
                if (response.ok) {
                    const data = await response.json();
                    console.log('🔍 Payment API response:', data);
                    
                    // Handle different response structures
                    if (data.payments) {
                        paymentsData = data.payments;
                    } else if (Array.isArray(data)) {
                        paymentsData = data;
                    } else if (data.data && Array.isArray(data.data)) {
                        paymentsData = data.data;
                    } else {
                        console.warn('⚠️ Unexpected payment data structure:', data);
                        paymentsData = [];
                    }
                    
                    displayPayments(paymentsData);
                    updatePaymentStats();
                } else {
                    throw new Error('Failed to load payments');
                }
            } catch (error) {
                console.error('Error loading payments:', error);
                paymentsData = [];
                document.getElementById('paymentsBody').innerHTML = '<tr><td colspan="8">❌ Error loading payments: ' + error.message + '</td></tr>';
            }
        }

        function displayPayments(payments) {
            const tbody = document.getElementById('paymentsBody');
            if (!payments || payments.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8">No payments found</td></tr>';
                return;
            }

            tbody.innerHTML = payments.map(payment => `
                <tr>
                    <td>#${payment.booking_id}</td>
                    <td>${payment.customer_name || 'N/A'}</td>
                    <td>${payment.service_type || 'N/A'}</td>
                    <td>KSh ${payment.amount}</td>
                    <td>${payment.payment_method}</td>
                    <td>
                        <span class="badge ${payment.status === 'received' ? 'badge-success' : 'badge-warning'}">
                            ${payment.status === 'received' ? '✅ Received' : '⏳ Pending'}
                        </span>
                    </td>
                    <td>${new Date(payment.created_at).toLocaleDateString()}</td>
                    <td>
                        ${payment.status === 'pending' ? 
                            `<button onclick="markPaymentReceived(${payment.id})" class="btn btn-success btn-sm">✅ Mark Received</button>` :
                            `<button onclick="markPaymentPending(${payment.id})" class="btn btn-warning btn-sm">⏳ Mark Pending</button>`
                        }
                        <button onclick="viewPaymentDetails(${payment.id})" class="btn btn-info btn-sm">👁️ View</button>
                    </td>
                </tr>
            `).join('');
        }

        function updatePaymentStats() {
    const totalRevenue = paymentsData.reduce((sum, p) => sum + p.amount, 0);
    const pendingCount = paymentsData.filter(p => p.status === 'pending').length;
    const receivedCount = paymentsData.filter(p => p.status === 'received').length;
    
    // Calculate today's revenue
    const today = new Date().toDateString();
    const todayRevenue = paymentsData
        .filter(p => new Date(p.created_at).toDateString() === today)
        .reduce((sum, p) => sum + p.amount, 0);

    document.getElementById('totalRevenuePayments').textContent = `KSh ${totalRevenue.toFixed(2)}`;
    document.getElementById('pendingPayments').textContent = pendingCount;
    document.getElementById('receivedPayments').textContent = receivedCount;
    document.getElementById('todayRevenue').textContent = `KSh ${todayRevenue.toFixed(2)}`;
}

        async function markPaymentReceived(paymentId) {
            try {
                const response = await fetch(`/api/payment-management/${paymentId}/mark-received`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (response.ok) {
                    await loadPayments();
                    alert('✅ Payment marked as received!');
                } else {
                    throw new Error('Failed to update payment');
                }
            } catch (error) {
                console.error('Error updating payment:', error);
                alert('❌ Error updating payment: ' + error.message);
            }
        }

        async function markPaymentPending(paymentId) {
            try {
                const response = await fetch(`/api/payment-management/${paymentId}/mark-pending`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (response.ok) {
                    await loadPayments();
                    alert('✅ Payment marked as pending!');
                } else {
                    throw new Error('Failed to update payment');
                }
            } catch (error) {
                console.error('Error updating payment:', error);
                alert('❌ Error updating payment: ' + error.message);
            }
        }

        function viewPaymentDetails(paymentId) {
            const payment = paymentsData.find(p => p.id === paymentId);
            if (!payment) return;

            const modalHtml = `
                <div class="modal-overlay" id="paymentDetailsModal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>Payment Details</h3>
                            <button onclick="closeModal('paymentDetailsModal')" class="close-btn">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="detail-row">
                                <strong>Booking ID:</strong> #${payment.booking_id}
                            </div>
                            <div class="detail-row">
                                <strong>Customer:</strong> ${payment.customer_name || 'N/A'}
                            </div>
                            <div class="detail-row">
                                <strong>Service:</strong> ${payment.service_type || 'N/A'}
                            </div>
                            <div class="detail-row">
                                <strong>Amount:</strong> KSh ${payment.amount}
                            </div>
                            <div class="detail-row">
                                <strong>Payment Method:</strong> ${payment.payment_method}
                            </div>
                            <div class="detail-row">
                                <strong>Status:</strong> 
                                <span class="badge ${payment.status === 'received' ? 'badge-success' : 'badge-warning'}">
                                    ${payment.status === 'received' ? '✅ Received' : '⏳ Pending'}
                                </span>
                            </div>
                            <div class="detail-row">
                                <strong>Created:</strong> ${new Date(payment.created_at).toLocaleString()}
                            </div>
                            ${payment.payment_received_at ? 
                                `<div class="detail-row">
                                    <strong>Received:</strong> ${new Date(payment.payment_received_at).toLocaleString()}
                                </div>` : ''
                            }
                            ${payment.payment_notes ? 
                                `<div class="detail-row">
                                    <strong>Notes:</strong> ${payment.payment_notes}
                                </div>` : ''
                            }
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        function setupPaymentEventListeners() {
            // Search functionality
            const searchInput = document.getElementById('paymentSearch');
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    const query = this.value.toLowerCase();
                    const filtered = paymentsData.filter(payment => 
                        payment.customer_name?.toLowerCase().includes(query) ||
                        payment.service_type?.toLowerCase().includes(query) ||
                        payment.booking_id.toString().includes(query)
                    );
                    displayPayments(filtered);
                });
            }

            // Status filter
            const statusFilter = document.getElementById('paymentStatusFilter');
            if (statusFilter) {
                statusFilter.addEventListener('change', function() {
                    const status = this.value;
                    const filtered = status ? paymentsData.filter(p => p.status === status) : paymentsData;
                    displayPayments(filtered);
                });
            }
        }

        // ========================================
        // CLIENT MANAGEMENT FUNCTIONS
        // ========================================

        async function initializeClientManagement() {
            console.log('🔧 Initializing client management...');
            await loadClients();
            setupClientEventListeners();
        }

        async function loadClients() {
            try {
                const response = await fetch('/api/clients');
                if (response.ok) {
                    const data = await response.json();
console.log('🔍 Client API response:', data);

// Handle different response structures
if (data.clients) {
    clientsData = data.clients;
} else if (Array.isArray(data)) {
    clientsData = data;
} else if (data.data && Array.isArray(data.data)) {
    clientsData = data.data;
} else {
    console.warn('⚠️ Unexpected client data structure:', data);
    clientsData = [];
}
                    displayClients(clientsData);
                    updateClientStats();
                } else {
                    throw new Error('Failed to load clients');
                }
            } catch (error) {
                console.error('Error loading clients:', error);
                document.getElementById('clientsBody').innerHTML = '<tr><td colspan="7">❌ Error loading clients</td></tr>';
            }
        }

        function displayClients(clients) {
            const tbody = document.getElementById('clientsBody');
            if (!clients || clients.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7">No clients found</td></tr>';
                return;
            }

            tbody.innerHTML = clients.map(client => `
                <tr>
                    <td>${client.name}</td>
                    <td>${client.phone}</td>
                    <td>${client.email || 'N/A'}</td>
                    <td>${client.total_bookings || 0}</td>
                    <td>KSh ${(client.total_spent || 0).toFixed(2)}</td>
                    <td>${client.last_booking_date ? new Date(client.last_booking_date).toLocaleDateString() : 'Never'}</td>
                    <td>
                        <button onclick="viewClientDetails(${client.id})" class="btn btn-info btn-sm">👁️ View</button>
                        <button onclick="editClientPreferences(${client.id})" class="btn btn-warning btn-sm">✏️ Edit</button>
                    </td>
                </tr>
            `).join('');
        }

        function updateClientStats() {
            const totalClients = clientsData.length;
            const activeClients = clientsData.filter(c => c.is_active).length;
            const repeatBookings = clientsData.filter(c => (c.total_bookings || 0) > 1).length;

            document.getElementById('totalClients').textContent = totalClients;
            document.getElementById('activeClients').textContent = activeClients;
            document.getElementById('repeatBookings').textContent = repeatBookings;
        }

        function viewClientDetails(clientId) {
            const client = clientsData.find(c => c.id === clientId);
            if (!client) return;

            const modalHtml = `
                <div class="modal-overlay" id="clientDetailsModal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>Client Details</h3>
                            <button onclick="closeModal('clientDetailsModal')" class="close-btn">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="detail-row">
                                <strong>Name:</strong> ${client.name}
                            </div>
                            <div class="detail-row">
                                <strong>Phone:</strong> ${client.phone}
                            </div>
                            <div class="detail-row">
                                <strong>Email:</strong> ${client.email || 'N/A'}
                            </div>
                            <div class="detail-row">
                                <strong>Address:</strong> ${client.address || 'N/A'}
                            </div>
                            <div class="detail-row">
                                <strong>Total Bookings:</strong> ${client.total_bookings || 0}
                            </div>
                            <div class="detail-row">
                                <strong>Total Spent:</strong> KSh ${(client.total_spent || 0).toFixed(2)}
                            </div>
                            <div class="detail-row">
                                <strong>Last Booking:</strong> ${client.last_booking_date ? new Date(client.last_booking_date).toLocaleDateString() : 'Never'}
                            </div>
                            <div class="detail-row">
                                <strong>Favorite Service:</strong> ${client.favorite_service || 'N/A'}
                            </div>
                            <div class="detail-row">
                                <strong>Preferred Barber:</strong> ${client.preferred_barber_name || 'N/A'}
                            </div>
                            ${client.notes ? 
                                `<div class="detail-row">
                                    <strong>Notes:</strong> ${client.notes}
                                </div>` : ''
                            }
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        function editClientPreferences(clientId) {
            const client = clientsData.find(c => c.id === clientId);
            if (!client) return;

            const modalHtml = `
                <div class="modal-overlay" id="editClientModal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>Edit Client Preferences</h3>
                            <button onclick="closeModal('editClientModal')" class="close-btn">&times;</button>
                        </div>
                        <div class="modal-body">
                            <form id="editClientForm">
                                <div class="form-group">
                                    <label>Preferred Service:</label>
                                    <input type="text" id="preferredService" value="${client.preferred_service || ''}" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label>Preferred Barber:</label>
                                    <input type="text" id="preferredBarber" value="${client.preferred_barber_name || ''}" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label>Notes:</label>
                                    <textarea id="clientNotes" class="form-control" rows="3">${client.notes || ''}</textarea>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button onclick="saveClientPreferences(${client.id})" class="btn btn-success">💾 Save Changes</button>
                            <button onclick="closeModal('editClientModal')" class="btn btn-secondary">❌ Cancel</button>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        async function saveClientPreferences(clientId) {
            try {
                const form = document.getElementById('editClientForm');
                const data = {
                    preferred_service: document.getElementById('preferredService').value,
                    preferred_barber_name: document.getElementById('preferredBarber').value,
                    notes: document.getElementById('clientNotes').value
                };

                const response = await fetch(`/api/clients/${clientId}/preferences`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    await loadClients();
                    closeModal('editClientModal');
                    alert('✅ Client preferences updated successfully!');
                } else {
                    throw new Error('Failed to update client preferences');
                }
            } catch (error) {
                console.error('Error updating client preferences:', error);
                alert('❌ Error updating client preferences: ' + error.message);
            }
        }

        function setupClientEventListeners() {
            // Search functionality
            const searchInput = document.getElementById('clientSearch');
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    const query = this.value.toLowerCase();
                    const filtered = clientsData.filter(client => 
                        client.name.toLowerCase().includes(query) ||
                        client.phone.includes(query) ||
                        (client.email && client.email.toLowerCase().includes(query))
                    );
                    displayClients(filtered);
                });
            }

            // Status filter
            const statusFilter = document.getElementById('clientStatusFilter');
            if (statusFilter) {
                statusFilter.addEventListener('change', function() {
                    const status = this.value;
                    const filtered = status ? clientsData.filter(c => 
                        status === 'active' ? c.is_active : !c.is_active
                    ) : clientsData;
                    displayClients(filtered);
                });
            }
        }

        // ========================================
        // UTILITY FUNCTIONS
        // ========================================

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.remove();
            }
        }
        
        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // ========================================
        // ADD PAYMENT MODAL
        // ========================================
        
        function showAddPaymentModal() {
            console.log('🔧 showAddPaymentModal called');
            console.log('🔧 paymentsData:', paymentsData);
            console.log('🔧 closeModal function:', typeof closeModal);
            console.log('🔧 saveNewPayment function:', typeof saveNewPayment);
            
            const modalHtml = `
                <div class="modal-overlay" id="addPaymentModal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>➕ Add New Payment</h3>
                            <button class="close-btn" data-modal-id="addPaymentModal">&times;</button>
                        </div>
                        <div class="modal-body">
                            <form id="addPaymentForm">
                                <div class="form-group">
                                    <label>Customer Name:</label>
                                    <input type="text" id="customerName" class="form-control" required>
                                </div>
                                <div class="form-group">
                                    <label>Service Type:</label>
                                    <input type="text" id="serviceType" class="form-control" required>
                                </div>
                                <div class="form-group">
                                    <label>Amount (KSh):</label>
                                    <input type="number" id="amount" class="form-control" step="0.01" required>
                                </div>
                                <div class="form-group">
                                    <label>Payment Method:</label>
                                    <select id="paymentMethod" class="form-control" required>
                                        <option value="">Select payment method</option>
                                        <option value="cash">Cash</option>
                                        <option value="mpesa">M-Pesa</option>
                                        <option value="card">Card</option>
                                        <option value="bank">Bank Transfer</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Status:</label>
                                    <select id="paymentStatus" class="form-control" required>
                                        <option value="pending">⏳ Pending</option>
                                        <option value="received">✅ Received</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Notes (Optional):</label>
                                    <textarea id="paymentNotes" class="form-control" rows="3" placeholder="Any additional notes..."></textarea>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button id="savePaymentBtn" class="btn btn-success">💾 Save Payment</button>
                            <button class="btn btn-secondary" data-modal-id="addPaymentModal">❌ Cancel</button>
                        </div>
                    </div>
                </div>
            `;
            
            console.log('🔧 Inserting modal HTML');
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            console.log('🔧 Modal HTML inserted');
            
            // Add event listeners for modal buttons
            const savePaymentBtn = document.getElementById('savePaymentBtn');
            if (savePaymentBtn) {
                savePaymentBtn.addEventListener('click', saveNewPayment);
                console.log('🔧 Save Payment button event listener added');
            }
            
            const cancelBtn = document.querySelector('#addPaymentModal .btn-secondary');
            if (cancelBtn) {
                cancelBtn.addEventListener('click', function() {
                    closeModal('addPaymentModal');
                });
                console.log('🔧 Cancel button event listener added');
            }
        }
        
        async function saveNewPayment() {
            console.log('🔧 saveNewPayment called');
            try {
                const form = document.getElementById('addPaymentForm');
                console.log('🔧 Form found:', form);
                
                const data = {
                    customer_name: document.getElementById('customerName').value,
                    service_type: document.getElementById('serviceType').value,
                    amount: parseFloat(document.getElementById('amount').value),
                    payment_method: document.getElementById('paymentMethod').value,
                    status: document.getElementById('paymentStatus').value,
                    notes: document.getElementById('paymentNotes').value
                };
                
                console.log('🔧 Form data:', data);
                
                // Create a mock payment object (since we don't have a real API endpoint)
                const newPayment = {
                    id: Date.now(), // Temporary ID
                    booking_id: 'Manual',
                    customer_name: data.customer_name,
                    service_type: data.service_type,
                    amount: data.amount,
                    payment_method: data.payment_method,
                    status: data.status,
                    payment_notes: data.notes,
                    created_at: new Date().toISOString()
                };
                
                // Add to local data
                paymentsData.push(newPayment);
                
                // Update display and stats
                displayPayments(paymentsData);
                updatePaymentStats();
                
                // Close modal
                closeModal('addPaymentModal');
                
                // Clear form
                form.reset();
                
                alert('✅ Payment added successfully!');
                
            } catch (error) {
                console.error('Error adding payment:', error);
                alert('❌ Error adding payment: ' + error.message);
            }
        }
        
        // Show notification function
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.innerHTML = `
                <div class="notification-content">
                    <span class="notification-message">${message}</span>
                    <button class="notification-close" onclick="this.parentElement.parentElement.remove()">&times;</button>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }
        
        // Booking action functions
        async function viewBookingDetails(bookingId) {
            try {
                const response = await fetch(`/api/bookings/${bookingId}`);
                if (!response.ok) throw new Error('Failed to fetch booking details');
                
                const data = await response.json();
                if (!data.success) throw new Error(data.message);
                
                const booking = data.booking;
                
                const modalHtml = `
                    <div class="modal-overlay" id="viewBookingModal">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h3>👁️ Booking Details</h3>
                                <button class="close-btn" data-modal-id="viewBookingModal">&times;</button>
                            </div>
                            <div class="modal-body">
                                <div class="booking-details">
                                    <div class="detail-row">
                                        <strong>Customer:</strong> ${escapeHtml(booking.customer_name)}
                                    </div>
                                    <div class="detail-row">
                                        <strong>Phone:</strong> ${escapeHtml(booking.customer_phone)}
                                    </div>
                                    <div class="detail-row">
                                        <strong>Service:</strong> ${escapeHtml(booking.service_type)}
                                    </div>
                                    <div class="detail-row">
                                        <strong>Date & Time:</strong> ${new Date(booking.preferred_datetime).toLocaleString()}
                                    </div>
                                    <div class="detail-row">
                                        <strong>Barber:</strong> ${escapeHtml(booking.barber_name || 'Unassigned')}
                                    </div>
                                    <div class="detail-row">
                                        <strong>Amount:</strong> KES ${(booking.service_price || 0).toLocaleString()}
                                    </div>
                                    <div class="detail-row">
                                        <strong>Status:</strong> <span class="status-badge status-${escapeHtml(booking.status)}">${escapeHtml(booking.status)}</span>
                                    </div>
                                    <div class="detail-row">
                                        <strong>Payment Status:</strong> <span class="status-badge status-${escapeHtml(booking.payment_status)}">${escapeHtml(booking.payment_status)}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                
            } catch (error) {
                console.error('Error viewing booking details:', error);
                alert('❌ Error loading booking details: ' + error.message);
            }
        }
        
        // DUPLICATE FUNCTION REMOVED - This function is defined earlier in the file
        
        // DUPLICATE FUNCTION REMOVED - This function is defined earlier in the file
        
        // DUPLICATE FUNCTION REMOVED - This function is defined earlier in the file
        
        // DUPLICATE FUNCTION REMOVED - This function is defined earlier in the file
        
        // Test daily summary function
        async function testDailySummary() {
            try {
                console.log('🧪 Testing daily summary...');
                
                const response = await fetch('/api/test-daily-summary', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('✅ Daily summaries sent successfully! Check console for details.');
                    console.log('📊 Daily summary test result:', result);
                } else {
                    alert('❌ Error sending daily summaries: ' + result.error);
                    console.error('❌ Daily summary test error:', result);
                }
                
            } catch (error) {
                console.error('❌ Error testing daily summary:', error);
                alert('❌ Error testing daily summary: ' + error.message);
            }
        }
    </script>
</body>
</html>